<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>CoinRader - æš—å·è³‡ç”£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<!-- SEO / Canonical -->
<meta content="CoinRaderã¯æš—å·è³‡ç”£ã®æ™‚ä¾¡ç·é¡TOP20ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã€ä¸Šæ˜‡ç‡ã€å‡ºæ¥é«˜ã‚’3åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã™ã€‚" name="description"/>
<link href="https://coinrader.net/" rel="canonical"/>
<!-- Favicon / PWA -->
<link href="/assets/icons/favicon.ico" rel="icon"/>
<link href="/assets/icons/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/assets/icons/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/assets/icons/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/site.webmanifest" rel="manifest"/>
<meta content="#0f172a" name="theme-color"/>
<!-- OGP -->
<meta content="website" property="og:type"/>
<meta content="CoinRader" property="og:site_name"/>
<meta content="CoinRader - æš—å·è³‡ç”£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" property="og:title"/>
<meta content="æ™‚ä¾¡ç·é¡TOP20ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã€ä¸Šæ˜‡ç‡ã€å‡ºæ¥é«˜ã‚’3åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ã€‚" property="og:description"/>
<meta content="https://coinrader.net/" property="og:url"/>
<meta content="https://coinrader.net/assets/og/ogp.png?v=20260124" property="og:image"/>
<meta content="1200" property="og:image:width"/>
<meta content="630" property="og:image:height"/>
<!-- Twitter -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="CoinRader - æš—å·è³‡ç”£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" name="twitter:title"/>
<meta content="æ™‚ä¾¡ç·é¡TOP20ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã€ä¸Šæ˜‡ç‡ã€å‡ºæ¥é«˜ã‚’3åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ã€‚" name="twitter:description"/>
<meta content="https://coinrader.net/assets/og/ogp.png?v=20260124" name="twitter:image"/>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TDEBXC7DH6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TDEBXC7DH6');
</script>
<style>
  .hero{padding:28px 0 16px;}
  .hero-inner{max-width:1600px;margin:0 auto;padding:0 18px;}
  .hero-copy{padding:18px 16px;border:1px solid rgba(255,255,255,.10);border-radius:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));}
  .hero-badges{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .badge{font-size:12px;padding:4px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.04);color:rgba(229,231,235,.9)}
  .hero-title{margin:8px 0 8px;font-size:28px;line-height:1.2;letter-spacing:.2px}
  .hero-sub{margin:0 0 14px;color:rgba(229,231,235,.85);font-size:14px;line-height:1.7}
  .hero-cta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0 6px}
  .hero-note{margin:10px 0 0;color:rgba(229,231,235,.55);font-size:12px}

  /* PC/ã‚¹ãƒãƒ›ã®æ”¹è¡Œåˆ¶å¾¡ */
  .br-sp{display:none}
  .br-pc{display:inline}

  @media (max-width: 640px){
    .hero{padding:18px 0 10px}
    .hero-title{font-size:22px}
    .hero-cta .btn{width:100%;text-align:center}
    .br-sp{display:inline}
    .br-pc{display:none}
  }
  *{ box-sizing:border-box; }
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    background:#0f172a; color:#e5e7eb; margin:0; padding:12px;
  padding-top: calc(var(--hdr-h) + 12px);
}
  h1{ margin:6px 4px 10px; font-size:20px; letter-spacing:.2px; }

  .topbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:0 4px 10px; }
  .pill{ border:1px solid #374151; background:#111827; color:#e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; }
  .btn{
    padding:8px 12px; border-radius:999px; border:1px solid #374151;
    background:#111827; color:#e5e7eb; cursor:pointer; font-size:12px;
  }
  .btn.primary{ background:#1e88e5; border-color:#1e88e5; color:#fff; }
  .btn:disabled{ opacity:.55; cursor:not-allowed; }

  .nav{ display:flex; gap:8px; flex-wrap:wrap; margin:0 4px 14px; }
  .nav .btn{ padding:6px 12px; font-size:12px; }

  section{ margin:0 4px 18px; max-width:none; padding:0; }
.section-header{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin:0 0 10px; }
  .section-title{ font-size:15px; font-weight:700; color:#f9fafb; }
  .section-sub{ font-size:12px; color:#9ca3af; margin-top:3px; }
  .section-actions{ display:flex; gap:8px; align-items:center; }
  .linkbtn{
    display:inline-flex; align-items:center; justify-content:center;
    text-decoration:none; color:#e5e7eb;
    border:1px solid #374151; background:#111827;
    padding:6px 10px; border-radius:999px; font-size:12px;
  }
  .linkbtn:hover{ border-color:#6b7280; }

  .grid{
    display:grid;
    gap:12px;
    align-items:stretch;
    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  }

  /* 1200pxä»¥ä¸Šã¯å¿…ãš5åˆ— */
  @media (min-width: 1200px){
    .grid{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
  }

  
  /* ===== Smooth auto-refresh (keep cards visible) ===== */
  .grid.refreshing{ position:relative; }
  .grid.refreshing::after{
    content:"æ›´æ–°ä¸­â€¦";
    position:absolute;
    top:10px; right:12px;
    font-size:11px;
    color:rgba(229,231,235,.85);
    background:rgba(17,24,39,.65);
    border:1px solid rgba(148,163,184,.25);
    padding:2px 8px;
    border-radius:999px;
    pointer-events:none;
    z-index:3;
  }
  .grid.refreshing .card{ opacity:.96; }
/* responsive columns (uniform across sections) */
  .card{
    position:relative; background:#111827; border-radius:12px; padding:10px 12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.45); cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease;
    overflow:hidden;
    min-width:0;
  }
  /* ===== Card height / bottom alignment (index grids) ===== */
  .grid .card{
    display:flex;
    flex-direction:column;
    height:100%;
  }

  /* ä¸Šéƒ¨ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼/ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã¯ä¸Šã«å¯„ã›ãŸã¾ã¾ */
  .grid .card .card-header{
    flex:0 0 auto;
  }

  /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã®canvasï¼‰ã‚’å¸¸ã«ä¸‹ç«¯ã«å¯„ã›ã‚‹ */
  .grid .card canvas{
    margin-top:auto !important;
  }

  /* å¿µã®ãŸã‚ï¼šä½™ç™½ã‚’çµ±ä¸€ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã®æœ€å¾ŒãŒè©°ã¾ã‚Šéããªã„ã‚ˆã†ã«ï¼‰ */
  .grid .card canvas{
    margin-bottom:2px;
  }

  .card:hover{ transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.5); }

  .card.up{ border-left:4px solid #1e88e5; }
  .card.down{ border-left:4px solid #d32f2f; }

  .rank-badge{
    position:absolute; top:8px; left:8px; width:32px; height:20px;
    display:flex; align-items:center; justify-content:center;
    font-size:13px; font-weight:700; border-radius:6px; color:#fff;
    background:#374151; z-index:2;
  }
  .rank-1{ background:#facc15; color:#111827; }
  .rank-2{ background:#9ca3af; color:#111827; }
  .rank-3{ background:#b45309; color:#fff; }

  .card-header{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
  .coin-header{ display:flex; align-items:center; gap:8px; padding-left:36px; min-width:0; }
  .coin-icon{ width:28px; height:28px; border-radius:50%; }
  .coin-name{ font-weight:600; font-size:14px; color:#f9fafb; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:150px; }
  .coin-symbol{ font-size:11px; color:#9ca3af; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .price{ font-size:15px; font-weight:600; color:#f9fafb; text-align:right; }
  .meta{ font-size:11px; color:#9ca3af; text-align:right; margin-top:2px; }
  .change{ font-size:12px; text-align:right; margin-top:2px; }
  .positive{ color:#4ade80; }
  .negative{ color:#f87171; }

  canvas{ display:block; width:100% !important; height:48px !important; margin-top:6px; }

  .msg{ grid-column:1 / -1; padding:10px 8px; color:#9ca3af; }
  .msg.err{ color:#f87171; }

  /* Market Overview */
  .overview{ display:grid; grid-template-columns: 1fr; gap:12px; }
  .overview.is-collapsed{display:none;}
  @media (min-width: 900px){ .overview{ grid-template-columns: 360px 1fr; } }
 
  .overview-card{ background:#111827; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.45); }
  .overview-note{ font-size:11px; color:#9ca3af; margin-top:8px; }
  .donut-wrap{ width:100%; max-width:340px; aspect-ratio:1/1; margin:0 auto; }
  .donut-wrap canvas{ width:100% !important; height:100% !important; margin-top:0; }
  .dom-metrics{ margin-top:10px; font-size:12px; color:#cbd5e1; line-height:1.4; text-align:center; }
 
  .kpi-grid{ display:grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap:10px; }
  @media (min-width: 560px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
 
  .kpi{ border:1px solid #1f2937; border-radius:12px; padding:10px 12px; background:#0b1220; }
  .kpi-label{ font-size:11px; color:#9ca3af; }
  .kpi-value{ margin-top:6px; font-size:16px; font-weight:700; color:#f9fafb; }

  .kpi-canvas{ width:100% !important; height:70px !important; margin-top:8px; }
  .kpi-canvas.tall{ height:90px !important; }
  .kpi-canvas.tiny{ height:46px !important; opacity:.8; }

  /* Sentiment gauge (Fear & Greed ä»£æ›¿) */
  .sent-gauge-wrap{ display:flex; justify-content:flex-start; align-items:flex-end; gap:14px; margin-top:10px; }
  .sent-gauge{
    width:220px; height:110px; position:relative; overflow:hidden;
    border-radius:220px 220px 0 0;
    background: conic-gradient(from 180deg,
      #ef4444 0deg 36deg,
      #f97316 36deg 72deg,
      #eab308 72deg 108deg,
      #22c55e 108deg 144deg,
      #16a34a 144deg 180deg,
      rgba(0,0,0,0) 180deg 360deg
    );
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  }
  .sent-gauge::before{
    content:"";
    position:absolute; left:12px; right:12px; bottom:-98px;
    width:auto; height:196px;
    background: rgba(15,23,42,.92);
    border-radius:999px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  }
  .sent-needle{
    position:absolute; left:50%; bottom:0;
    width:2px; height:96px;
    background: rgba(255,255,255,.92);
    transform-origin: bottom center;
    transform: translateX(-50%) rotate(0deg);
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
  }
  .sent-needle::after{
    content:"";
    position:absolute; left:50%; bottom:-6px;
    width:14px; height:14px;
    background: rgba(255,255,255,.92);
    border-radius:999px;
    transform: translateX(-50%);
    box-shadow: 0 6px 14px rgba(0,0,0,.35);
  }
  .sent-gauge-meta{ display:flex; flex-direction:column; gap:4px; }
  .sent-gauge-score{ font-size:26px; font-weight:800; letter-spacing:.2px; }
  .sent-gauge-label{ font-size:12px; color: rgba(229,231,235,.75); }


  /* --- Market Overview KPI strip (CMC-like quick glance) --- */
  .overview-kpi-strip{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 14px;}
  .kpi-tile{background:#0b1224;border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:10px 12px;}
  .kpi-tile-title{font-size:11px;color:#9ca3af;letter-spacing:.02em;}
  .kpi-tile-big{margin-top:6px;font-size:18px;font-weight:800;color:#f9fafb;line-height:1.1;}
  .kpi-tile-sub{margin-top:4px;font-size:11px;color:#cbd5e1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .kpi-tile-sub .pos{color:#4ade80;font-weight:700;}
  .kpi-tile-sub .neg{color:#f87171;font-weight:700;}
  
  /* Summary KPI compact rows */
  .summary-kpis .kpi-tile{ padding:9px 12px; }
  .summary-kpis .kpi-value-row{ display:flex; align-items:baseline; gap:10px; margin-top:6px; flex-wrap:wrap; }
  .summary-kpis .kpi-tile-big{ margin-top:0; }
  .summary-kpis .kpi-tile-sub.inline{ margin-top:0; font-size:12px; color:#cbd5e1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  
  .kpi-bar-caption{margin-top:6px;font-size:10px;line-height:1.2;text-align:center;color:rgba(229,231,235,0.60);min-height:12px;letter-spacing:.2px;user-select:none;}
.summary-kpis .mini-vis{ margin-top:6px; }
@media (max-width: 520px){ .overview-kpi-strip{grid-template-columns:repeat(2,minmax(0,1fr));} .kpi-tile-big{font-size:16px;} }

  .kpi-sub{ margin-top:6px; font-size:11px; color:#9ca3af; line-height:1.35; }
  .kpi-meta{ margin-top:6px; font-size:12px; color:#d1d5db; }

  .kpi-legend{ margin-top:6px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:11px; color:#9ca3af; }
  .kpi-legend .item{ display:inline-flex; align-items:center; gap:6px; }
  .kpi-legend .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; }
  .kpi-legend .dot.up{ background:rgba(30,136,229,0.9); }
  .kpi-legend .dot.down{ background:rgba(211,47,47,0.9); }

  .barline{ margin-top:8px; height:10px; width:100%; border-radius:999px; overflow:hidden; background:#0f172a; border:1px solid #1f2937; display:flex; }
  .bar-up{ background:rgba(30,136,229,0.75); height:100%; }
  .bar-down{ background:rgba(211,47,47,0.75); height:100%; }
  .bar-flat{ background:rgba(156,163,175,0.55); height:100%; }

  .centerbar{ margin-top:8px; height:10px; width:100%; border-radius:999px; overflow:hidden; background:#0f172a; border:1px solid #1f2937; position:relative; }
  .centerline{ position:absolute; left:50%; top:0; width:1px; height:100%; background:#334155; }
  .centerfill{ position:absolute; top:0; height:100%; border-radius:999px; }
  .centerfill.pos{ background:rgba(30,136,229,0.75); }
  .centerfill.neg{ background:rgba(211,47,47,0.75); }

  .stackbar{ margin-top:8px; height:10px; width:100%; border-radius:999px; overflow:hidden; background:#0f172a; border:1px solid #1f2937; display:flex; }
  .seg{ height:100%; }
  .seg.btc{ background:rgba(250,204,21,0.85); }
  .seg.eth{ background:rgba(96,165,250,0.85); }
  .seg.stable{ background:rgba(52,211,153,0.85); }
  .seg.other{ background:rgba(156,163,175,0.55); }
  /* Footer */
  .site-footer{
    margin-top: 28px;
    padding: 18px 14px;
    border-top: 1px solid rgba(255,255,255,0.08);
    color: rgba(229,231,235,0.85);
  }
  .footer-inner{ max-width: 1200px; margin: 0 auto; }
  .footer-note{ font-size: 12px; line-height: 1.6; opacity: 0.95; }
  .footer-links{
    display: flex; flex-wrap: wrap; gap: 10px 14px;
    margin-top: 10px;
  }
  .footer-links a{
    font-size: 12px;
    color: rgba(229,231,235,0.9);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .footer-copy{ margin-top: 10px; font-size: 12px; opacity: 0.75; }
  .brand { margin: 0 4px 6px; }
  .brandLink { display: inline-block; }
  .brandLogo{
    height: 28px;
    width: auto;
    display: block;
  }
  .btn-cta{
    display:inline-flex; align-items:center; justify-content:center;
    padding:9px 14px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
    color:#e5e7eb;
    text-decoration:none;
    font-weight:700;
  }
  .btn-cta:hover{ background:rgba(255,255,255,.10); }
  /* ===== CTA (åç›Šå°ç·š) ===== */
  .cta-block{
    margin: 0 4px 18px;
    padding: 12px 12px;
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 12px;
    background: rgba(255,255,255,.04);
    box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  }
  .cta-inner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .cta-title{ font-weight:800; font-size:14px; color:#f9fafb; }
  .cta-sub{ margin-top:4px; font-size:12px; color:#9ca3af; }
  .cta-actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .cta-note{ margin-top:8px; font-size:11px; color:rgba(229,231,235,.70); }

  .brand{
    max-width:1600px;
    margin:0 auto 6px;
    padding:0 18px;
  }

  /* sparkline (Chart.js) */
  .sparkline{width:100% !important; height:64px !important; display:block; margin-top:10px;}
  .card canvas.sparkline{max-width:100%;}



  /* --- Header (Aæ¡ˆ: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰UI) --- */
  /* ===== Aæ¡ˆï¼šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ­ã‚´éƒ¨åˆ†ï¼‰ã ã‘å›ºå®š ===== */
  .appHeader{
    position: sticky;
    top: 12px;          /* bodyã®padding:12pxã«åˆã‚ã›ã‚‹ */
    z-index: 1000;      /* ã‚«ãƒ¼ãƒ‰ã‚„ãƒãƒ£ãƒ¼ãƒˆã‚ˆã‚Šå‰é¢ã« */
  }

  /* å›ºå®šæ™‚ã«ä¸‹ãŒé€ã‘ãªã„ã‚ˆã†ã«ï¼ˆæ—¢å­˜ã®èƒŒæ™¯ã«ä¸Šæ›¸ãã§OKï¼‰ */
  .appHeader-inner{
    backdrop-filter: blur(10px);
    background: rgba(15, 23, 42, 0.92);
  }

  .appHeader{ margin: 0 4px 12px; }
  .appHeader-inner{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 10px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.015));
  }
  .appHeader-left{ display:flex; align-items:center; gap:12px; min-width:0; }
  .appHeader-right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .brandLogo{ height: 26px; }
  .headerNav{ display:flex; gap:8px; flex-wrap:wrap; }
  .btn.tab{ padding:6px 12px; font-size:12px; }
  .appSubline{ margin:8px 4px 0; font-size:12px; color:#9ca3af; }

  @media (max-width: 820px){
    .appHeader-inner{ align-items:flex-start; }
    .appHeader-left{ flex-wrap:wrap; }
    .appHeader-right{ width:100%; justify-content:flex-start; }
  }
  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—ãŒå›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ã«éš ã‚Œãªã„å¯¾ç­– */
  section { scroll-margin-top: 110px; }


/* --- Fix sentiment gauge rendering (avoid conic-gradient gaps) --- */
.sent-gauge-bg, .sent-gauge-inner{ display:none !important; }
.sent-gauge{ background: none !important; width: 220px; height: 120px; }
.sent-gauge-svg{ position:absolute; left:0; top:0; width:220px; height:120px; }
.sent-gauge-needle{ bottom: 10px; height: 62px; }
.sent-gauge-center{ bottom: 6px; }

/* --- Mobile header compaction --- */
@media (max-width: 520px){
  .appHeader{ top: 8px; margin: 0 6px 10px; }
  .appHeader-inner{ padding: 8px 10px; border-radius: 14px; }
  .brandLogo{ height: 20px; }
  .appSubline{ display:none; }
  .headerNav{ flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .headerNav::-webkit-scrollbar{ display:none; }
  .btn.tab{ padding: 6px 10px; font-size: 11px; }
  .appHeader-right{ gap: 6px; }
  .pill{ padding: 6px 10px; font-size: 11px; }
  #updatedPill{ display:none; }
  .btn-cta{ padding: 8px 10px; font-size: 12px; }
  /* fixed header anchor offset */
  section{ scroll-margin-top: 92px; }
}


/* ===== Side menu + compact header ===== */
:root{ --hdr-h: 64px; }
.appHeader{ position:fixed; top:0; left:0; right:0; z-index: 80; padding: 10px 0; margin:0; background: rgba(10,14,28,0.75); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.06); }
.hdr-inner{ width:100%; max-width: none; margin: 0; padding: 0 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
.hdr-left{ display:flex; align-items:center; gap:10px; min-width:0; }
.hdr-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
.topNote{ max-width:1600px; margin: 6px auto 0; padding: 0 16px; color: var(--muted); font-size: 12px; }

/* header should only show logo/status/update */
.navTabs, .startBtn{ display:none !important; }

.iconBtn.menuBtn{ width:36px; height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }
.iconBtn.menuBtn:hover{ background: rgba(255,255,255,.07); }
.burger{ position:relative; display:block; width:16px; height:2px; background:#e5e7eb; border-radius:2px; }
.burger::before,.burger::after{ content:""; position:absolute; left:0; width:16px; height:2px; background:#e5e7eb; border-radius:2px; }
.burger::before{ top:-6px; }
.burger::after{ top:6px; }

.sideMenuOverlay{ position:fixed; inset:0; background: rgba(0,0,0,.55); z-index: 90; }
.sideMenu{ position:fixed; top: calc(var(--hdr-h) + 12px); left: 12px; width: 220px;
  background: rgba(10,16,28,.92); border:1px solid rgba(255,255,255,.10); border-radius: 16px; padding: 10px; z-index: 95;
  box-shadow: 0 14px 44px rgba(0,0,0,.45); backdrop-filter: blur(10px);
}
.sideMenuHeader{ display:flex; align-items:center; justify-content:space-between; padding: 4px 4px 8px; }
.sideMenuTitle{ font-weight: 700; font-size: 13px; color:#e5e7eb; letter-spacing:.02em; }
.sideMenuNav, .sideMenuFooter{ display:flex; flex-direction:column; gap:6px; }
.sideMenuFooter{ margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,.08); }
.sideNavLink{ display:flex; align-items:center; gap:8px; padding: 9px 10px; border-radius: 12px; color:#e5e7eb; text-decoration:none; font-size: 13px; }
.sideNavLink:hover{ background: rgba(255,255,255,.06); }

/* Make sure fixed header doesn't hide anchor targets */
section[id]{ scroll-margin-top: calc(var(--hdr-h) + 16px); }

@media (max-width: 1200px){
  .sideMenu{ left: 12px; transform: translateX(-110%); transition: transform .22s ease; }
  .sideMenu.is-open{ transform: translateX(0); }
}
@media (min-width: 1201px){
  :root{ --dock-w: 252px; }
  body{ padding-left: var(--dock-w); }
  .sideMenuOverlay{ display:none !important; }
  .iconBtn.menuBtn{ display:none; }
  #menuCloseBtn{ display:none; }
  .sideMenu{ transform:none !important; opacity:1 !important; pointer-events:auto !important; }
}

@media (max-width: 640px){
  :root{ --hdr-h: 56px; }
  .brand img{ width: 34px; height: 34px; }
  .brand .title{ font-size: 14px; }
  .hdr-right{ gap:8px; }
  .statusPill, .updatedPill{ font-size: 11px; padding: 6px 8px; }
  .miniNote{ font-size:11px; padding:6px 8px; border-radius:999px; background:rgba(148,163,184,0.10); border:1px solid rgba(148,163,184,0.18); color:#cbd5e1; white-space:nowrap; }
  #refreshBtn{ padding: 7px 10px; font-size: 12px; }
}

/* sentiment gauge: we now use SVG only */
.sent-gauge::before{ display:none !important; }

/* ===== Mobile UX fixes (v40) ===== */
@media (max-width: 640px){
  /* Prevent header height jump when refresh button shows countdown */
  .hdr-right{ flex-wrap: nowrap !important; }
  #refreshBtn{ white-space: nowrap; min-width: 84px; }
  .statusPill{ white-space: nowrap; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
}

/* Section header: avoid "ã‚‚ã£ã¨è¦‹ã‚‹" vertical wrap on narrow screens */
@media (max-width: 520px){
  .section-header{ flex-direction: column; align-items: flex-start; }
  .section-actions{ width: 100%; justify-content: flex-end; }
  .linkbtn{ white-space: nowrap; }
}

/* Sentiment gauge (SVG) must keep a positioned container */
.sent-gauge{
  position: relative !important;
  overflow: hidden !important;
}



/* ===== Quick Summary (Aæ¡ˆ) ===== */
.summary-block{ margin-top: 18px; }
.summary-kpis{
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 12px;
  margin-top: 10px;
}

@media (max-width: 560px){
  .summary-kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .summary-kpis .kpi-tile.kpi-avg250{ grid-column: 1 / -1; }
  #sec-summary .section-sub{ display:none; }
}
.summary-lists{
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
  margin-top: 12px;
}
.summary-card{
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 12px 12px 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}
.summary-card-title{
  font-weight: 700;
  letter-spacing: .2px;
  margin-bottom: 8px;
  color: #e5e7eb;
}
.summary-ol{
  margin: 0;
  padding: 0 0 0 18px;
}
.summary-li{
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.summary-li:last-child{ border-bottom: 0; }
.summary-left{
  display: inline-flex;
  align-items: baseline;
  gap: 8px;
  min-width: 0;
}
.summary-rank{
  width: 22px;
  text-align: center;
  opacity: .95;
}
.summary-symbol{
  font-weight: 700;
  white-space: nowrap;
}
.summary-right{
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
}
.summary-right.positive{ color: #7dd3fc; } /* existing palette-esque */
.summary-right.negative{ color: #fb7185; }
.summary-li.muted{ opacity: .75; }
.summary-li.clickable{ cursor: pointer; }
.summary-li.clickable:hover{ background: rgba(255,255,255,0.03); border-radius: 10px; padding-left: 8px; padding-right: 8px; }

/* summary is the new KPI row, so hide the old strip to avoid duplication */
#overviewKpiStrip{ display:none; }

@media (max-width: 1100px){
  .summary-kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .summary-lists{ grid-template-columns: 1fr; }
}


.summary-right-wrap{
  display:inline-flex;
  align-items:center;
  gap:10px;
  white-space:nowrap;
}
.summary-ext{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:26px;
  height:22px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.02);
  font-size: 12px;
  opacity:.9;
}
.summary-ext:hover{ background: rgba(255,255,255,0.06); }
.flash{
  outline: 2px solid rgba(125,211,252,0.9);
  outline-offset: 2px;
  animation: flashPulse 1.2s ease-in-out 0s 1;
}
@keyframes flashPulse{
  0%{ box-shadow: 0 0 0 rgba(125,211,252,0.0); }
  40%{ box-shadow: 0 0 18px rgba(125,211,252,0.45); }
  100%{ box-shadow: 0 0 0 rgba(125,211,252,0.0); }
}


  /* ===== Mini visuals for Summary KPI (v68) ===== */
  .kpi-tile{ position:relative; }
  .mini-vis{ margin-top:10px; }
  /* RSI mini bar */
  .mini-rsi-track{
    position:relative;
    height:10px;
    border-radius:999px;
    background:rgba(148,163,184,0.26);
    overflow:hidden;
    box-shadow: inset 0 0 0 1px rgba(148,163,184,0.18);
  }
  .mini-rsi-zone{ position:absolute; top:0; bottom:0; }
  .mini-rsi-zone.low{ left:0; width:30%; background:rgba(255,82,82,0.70); }
  .mini-rsi-zone.mid{ left:30%; width:40%; background:rgba(120,186,255,0.45); }
  .mini-rsi-zone.high{ left:70%; width:30%; background:rgba(72,235,142,0.62); }
  .mini-rsi-th{ position:absolute; top:0; bottom:0; width:1px; background:rgba(226,232,240,0.45); }
  .mini-rsi-th.t30{ left:30%; }
  .mini-rsi-th.t70{ left:70%; }
  .mini-rsi-marker{
    position:absolute;
    top:50%;
    width:12px; height:12px;
    border-radius:50%;
    transform:translate(-50%,-50%);
    background:rgba(226,232,240,0.98);
    box-shadow:0 0 0 3px rgba(56,189,248,0.48), 0 0 18px rgba(56,189,248,0.70);
    animation: glowPulse 2.4s ease-in-out infinite;
    left:50%;
  }

  /* Sentiment mini bar (0-100) */
  .mini-sent-track{
    position:relative;
    height:10px;
    border-radius:999px;
    background:rgba(148,163,184,0.26);
    overflow:hidden;
    box-shadow: inset 0 0 0 1px rgba(148,163,184,0.18);
  }
  .mini-sent-zone{ position:absolute; top:0; bottom:0; }
  .mini-sent-zone.fear{ left:0; width:25%; background:rgba(255,82,82,0.70); }
  .mini-sent-zone.caution{ left:25%; width:25%; background:rgba(245,158,11,0.44); }
  .mini-sent-zone.neutral{ left:50%; width:25%; background:rgba(120,186,255,0.45); }
  .mini-sent-zone.greed{ left:75%; width:25%; background:rgba(72,235,142,0.62); }
  .mini-sent-th{ position:absolute; top:0; bottom:0; width:1px; background:rgba(226,232,240,0.40); }
  .mini-sent-th.t25{ left:25%; }
  .mini-sent-th.t50{ left:50%; }
  .mini-sent-th.t75{ left:75%; }
  .mini-sent-marker{
    position:absolute;
    top:50%;
    width:12px; height:12px;
    border-radius:50%;
    transform:translate(-50%,-50%);
    background:rgba(226,232,240,0.98);
    box-shadow:0 0 0 3px rgba(56,189,248,0.46), 0 0 18px rgba(56,189,248,0.70);
    animation: glowPulse 2.4s ease-in-out infinite;
    left:50%;
  }


  /* MA cross mini bar (v79: align colors with Sentiment/RSI style) */
.mini-ma-track{
  position:relative;
  height:10px;
  border-radius:999px;
  background:rgba(148,163,184,0.26);
  overflow:hidden;
  box-shadow: inset 0 0 0 1px rgba(148,163,184,0.18);
}
.mini-ma-zone{ position:absolute; top:0; bottom:0; }
/* å·¦â†’å³: å±é™º(DC) â†’ å®‰å…¨(GC) : èµ¤â†’é»„â†’é’â†’ç·‘ */
.mini-ma-zone.dc-strong{ left:0;  width:25%; background:rgba(255,82,82,0.60); }
.mini-ma-zone.dc-weak{   left:25%; width:25%; background:rgba(245,158,11,0.44); }
.mini-ma-zone.gc-weak{   left:50%; width:25%; background:rgba(120,186,255,0.45); }
.mini-ma-zone.gc-strong{ left:75%; width:25%; background:rgba(72,235,142,0.62); }

/* 0(ã‚¯ãƒ­ã‚¹)ã®åŸºæº–ç·š */
.mini-ma-center{ position:absolute; left:50%; top:-4px; bottom:-4px; width:1px; background:rgba(226,232,240,0.26); }

.mini-ma-marker{
  position:absolute;
  top:50%;
  width:10px; height:10px;
  border-radius:50%;
  transform:translate(-50%,-50%);
  background:rgba(226,232,240,0.98);
  box-shadow:0 0 0 3px rgba(56,189,248,0.22);
}

.mini-ma-label{
  margin-top:6px;
  font-size:10px;
  line-height:1.2;
  text-align:center;
  color:rgba(229,231,235,0.60);
  letter-spacing:.2px;
  user-select:none;
}

/* Dominance mini donut (SVG) */

  .mini-donut{
    width:44px; height:44px;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:0.95;
  }
  .mini-donut svg{ width:60px; height:60px; display:block; }
  .mini-donut .bg{ stroke:rgba(148,163,184,0.18); }
  .mini-donut .seg-btc{ stroke:rgba(250,204,21,0.90); }
  .mini-donut .seg-eth{ stroke:rgba(96,165,250,0.90); }
  .mini-donut .seg-stb{ stroke:rgba(52,211,153,0.85); }
  .mini-donut .seg-oth{ stroke:rgba(148,163,184,0.65); }
  .mini-donut circle{ fill:none; stroke-width:7; stroke-linecap:butt; }
  .mini-donut .rot{ transform:rotate(-90deg); transform-origin:50% 50%; }
  .kpi-with-donut{
    display:flex;
    flex-direction:column;
    align-items:stretch;
    justify-content:flex-start;
    gap:8px;
  }
  .kpi-with-donut .kpi-text{ flex:1 1 auto; min-width:0; }
    /* Dominance mini bar (v74) */
  .mini-dom-bar{
    width:100%;
    min-width:0;
    max-width:none;
    margin-top:0;
    align-self:stretch;
  }
  .mini-dom-track{
    position:relative;
    height:10px;
    border-radius:999px;
    overflow:hidden;
    background:rgba(148,163,184,0.16);
    box-shadow: inset 0 0 0 1px rgba(148,163,184,0.18);
  }
  .mini-dom-seg{ position:absolute; top:0; bottom:0; left:0; width:0%; }
  .mini-dom-seg.btc{ background:rgba(250,204,21,0.90); }
  .mini-dom-seg.eth{ background:rgba(96,165,250,0.90); }
  .mini-dom-seg.stb{ background:rgba(52,211,153,0.90); }
  .mini-dom-seg.oth{ background:rgba(148,163,184,0.62); }

  .mini-dom-tick{ position:absolute; top:-8px; bottom:-8px; width:1px; background:rgba(226,232,240,0.22); }
  .mini-dom-tick span{ position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:10px; color:rgba(203,213,225,0.72); }
  .mini-dom-tick.t50{ left:50%; }
  .mini-dom-tick.t60{ left:60%; }

  /* Avg 24h sparkline */
  .mini-spark{ height:34px; margin-top:8px; }
  .mini-spark svg{ width:100%; height:34px; display:block; }
  .mini-spark .zero{ stroke:rgba(170,190,215,0.36); stroke-width:1; }
  .mini-spark .line{ stroke:rgba(226,232,240,0.90); stroke-width:2; fill:none; }
  .mini-spark .fill{
    fill:rgba(59,130,246,0.12);
    stroke:none;
  }


@media (max-width: 720px){
  .hdr-inner{ flex-wrap: nowrap; gap: 8px; }
  .hdr-right{ flex-wrap: nowrap; gap: 8px; }
  .miniNote{ display:none; }
  .updatedPill{ max-width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .statusPill{ white-space: nowrap; }
}

/* --- Summary KPI: Breadth mini bar --- */
.kpi-mini-breadth{margin-top:10px}
.breadth-track{
  height:10px;
  border-radius:999px;
  overflow:hidden;
  background:rgba(255,255,255,0.08);
  display:flex;
}
.breadth-seg{height:100%}
.breadth-seg.up{background:rgba(52,211,153,0.85)}
.breadth-seg.down{background:rgba(248,113,113,0.85)}
.breadth-caption{margin-top:6px;font-size:10px;line-height:1.2;text-align:center;color:rgba(229,231,235,0.60);min-height:12px;letter-spacing:.2px;user-select:none}

</style>
</head>
<body>
<header class="appHeader" role="banner">
<div class="hdr-inner">
<div class="hdr-left">
<button aria-controls="sideMenu" aria-expanded="false" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" class="iconBtn menuBtn" id="menuBtn" type="button">
<span aria-hidden="true" class="burger"></span>
</button>
<a aria-label="CoinRader ãƒ›ãƒ¼ãƒ " class="brandLink" href="/">
<img alt="CoinRader" class="brandLogo" src="/assets/coinrader_logo_horizontal_075_dark.png"/>
</a>
</div>
<div class="hdr-right">
<div class="statusPill" id="statusPill"><span class="dot"></span><span>æ¥ç¶šä¸­</span></div>
<div class="miniNote" id="miniNote" title="è‡ªå‹•æ›´æ–°ï¼ˆç´„3åˆ†ã”ã¨ï¼‰">è‡ªå‹•3åˆ†</div>
<div class="updatedPill" id="updatedPill">æ›´æ–°: --</div>
<button class="btn small" id="refreshBtn" type="button">æ›´æ–°</button>
</div>
</div>
</header>
<div class="sideMenuOverlay" hidden="" id="sideMenuOverlay"></div>
<aside aria-hidden="true" class="sideMenu" id="sideMenu">
<div class="sideMenuHeader">
<div class="sideMenuTitle">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
<button aria-label="é–‰ã˜ã‚‹" class="iconBtn" id="menuCloseBtn" type="button">Ã—</button>
</div>
<nav aria-label="ãƒšãƒ¼ã‚¸å†…ãƒ¡ãƒ‹ãƒ¥ãƒ¼" class="sideMenuNav">
<a class="sideNavLink" href="#sec-trend" onclick="scrollToId('sec-trend'); return false;">ãƒˆãƒ¬ãƒ³ãƒ‰TOP5</a>
<a class="sideNavLink" href="#sec-gainers" onclick="scrollToId('sec-gainers'); return false;">ä¸Šæ˜‡ç‡TOP5</a>
<a class="sideNavLink" href="#sec-volume" onclick="scrollToId('sec-volume'); return false;">å‡ºæ¥é«˜TOP5</a>
<a class="sideNavLink" href="#sec-alt-volume" onclick="scrollToId('sec-alt-volume'); return false;">å‡ºæ¥é«˜ 24hå¤‰åŒ–ç‡</a>
<a class="sideNavLink" href="#sec-mcap" onclick="scrollToId('sec-mcap'); return false;">æ™‚ä¾¡ç·é¡TOP20</a>
<a class="sideNavLink" href="#sec-overview" onclick="scrollToId('sec-overview'); return false;">å¸‚å ´æ¦‚æ³</a>
</nav>
<div class="sideMenuFooter">
<a class="sideNavLink" href="/start">å§‹ã‚æ–¹</a>
<a class="sideNavLink" href="/data-sources">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</a>
<a class="sideNavLink" href="/ads-pr">åºƒå‘Šãƒ»PRè¡¨è¨˜</a>
<a class="sideNavLink" href="/privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
<a class="sideNavLink" href="/contact">ãŠå•ã„åˆã‚ã›</a>
</div>
</aside>
<section aria-label="ä»Šæ—¥ã®æ³¨ç›®" class="summary-block" id="sec-summary">
<div class="section-header">
<div>
<div class="section-title">ä»Šæ—¥ã®æ³¨ç›®</div>
<div class="section-sub">å¸‚å ´ã®ç©ºæ°—ã¨ã€ã„ã¾æ³¨ç›®ã®éŠ˜æŸ„ã‚’æœ€çŸ­ã§ç¢ºèªã§ãã¾ã™ã€‚</div>
</div>
<div class="section-actions">
<a class="linkbtn" href="#sec-overview" onclick="scrollToId('sec-overview'); return false;">å¸‚å ´æ¦‚æ³</a>
</div>
</div>
<div class="summary-kpis" id="summaryKpis">




<div class="kpi-tile kpi-avg250">
<div class="kpi-tile-title">ä¸Šä½250 å¹³å‡ï¼ˆ24hï¼‰</div>
<div class="kpi-value-row"><div class="kpi-tile-big" id="sumAvg24Main">-</div><div class="kpi-tile-sub inline" id="sumBreadthInline">â€”</div></div>
<div class="kpi-mini-breadth mini-vis" title="ä¸Šä½250ã®24hä¸Šæ˜‡/ä¸‹è½éŠ˜æŸ„æ•°ï¼ˆprice_change_percentage_24h ã‹ã‚‰ç®—å‡ºï¼‰">
<div aria-hidden="true" class="breadth-track">
<div class="breadth-seg up" id="sumBreadthSegUp"></div>
<div class="breadth-seg down" id="sumBreadthSegDown"></div>
</div>
<div class="breadth-caption kpi-bar-caption" id="sumBreadthCaption">ä¸Šæ˜‡/ä¸‹è½ï¼ˆ24hï¼‰</div>
</div>
</div>
<div class="kpi-tile">
<div class="kpi-tile-title">ææ€–æŒ‡æ•°ï¼ˆ0â€“100ï¼‰</div>
<div class="kpi-value-row"><div class="kpi-tile-big" id="sumSentMain">-</div><div class="kpi-tile-sub inline" id="sumSentSub">-</div></div>
<div aria-hidden="true" class="mini-vis">
<div class="mini-sent-track">
<div class="mini-sent-zone fear"></div>
<div class="mini-sent-zone caution"></div>
<div class="mini-sent-zone neutral"></div>
<div class="mini-sent-zone greed"></div>
<div class="mini-sent-th t25"></div>
<div class="mini-sent-th t50"></div>
<div class="mini-sent-th t75"></div>
<div class="mini-sent-marker" id="sumSentMarker"></div>
</div>
<div class="kpi-bar-caption">ææ€– â† 50 â†’ å¼·æ¬²</div>
</div>
</div><div class="kpi-tile">
<div class="kpi-tile-title">BTC RSIï¼ˆ14ï¼‰</div>
<div class="kpi-value-row"><div class="kpi-tile-big" id="sumRsiMain">-</div><div class="kpi-tile-sub inline" id="sumRsiSub">-</div></div>
<div aria-hidden="true" class="mini-vis">
<div class="mini-rsi-track">
<div class="mini-rsi-zone low"></div>
<div class="mini-rsi-zone mid"></div>
<div class="mini-rsi-zone high"></div>
<div class="mini-rsi-th t30"></div>
<div class="mini-rsi-th t70"></div>
<div class="mini-rsi-marker" id="sumRsiMarker"></div>
</div>
<div class="kpi-bar-caption">å£²ã‚‰ã‚Œã™ã â† 50 â†’ è²·ã‚ã‚Œã™ã</div>
</div>
</div><div class="kpi-tile">
<div class="kpi-tile-title">BTC ãƒ‰ãƒŸãƒŠãƒ³ã‚¹</div>
<div class="kpi-with-donut">
<div class="kpi-text">
<div class="kpi-value-row"><div class="kpi-tile-big" id="sumDomMain">-</div><div class="kpi-tile-sub inline" id="sumDomSub">-</div></div>
</div>
<div aria-hidden="true" class="mini-dom-bar mini-vis" title="BTC/ETH/ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«/Others æ§‹æˆ">
<div aria-label="Dominance bar" class="mini-dom-track" role="img">
<div class="mini-dom-seg btc" id="sumDomSegBtc"></div>
<div class="mini-dom-seg eth" id="sumDomSegEth"></div>
<div class="mini-dom-seg stb" id="sumDomSegStb"></div>
<div class="mini-dom-seg oth" id="sumDomSegOth"></div>
<div class="mini-dom-tick t50"><span>50</span></div>
<div class="mini-dom-tick t60"><span>60</span></div>
</div>
<div class="kpi-bar-caption">BTC / ETH / ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ« / ãã®ä»–</div>
</div>
</div>
</div><div class="kpi-tile kpi-ma">
<div class="kpi-tile-title">BTC MAã‚¯ãƒ­ã‚¹è·é›¢ï¼ˆ50/200ï¼‰</div>
<div class="kpi-value-row"><div class="kpi-tile-big" id="sumMaMain">-</div><div class="kpi-tile-sub inline" id="sumMaSub">-</div></div>
<div aria-hidden="true" class="mini-vis" title="SMA50ã¨SMA200ã®ä¹–é›¢ï¼ˆ%ï¼‰ã€‚0ã«è¿‘ã„ã»ã©ã‚¯ãƒ­ã‚¹ãŒè¿‘ã„ã€‚å·¦=DCå´(ãƒã‚¤ãƒŠã‚¹) / å³=GCå´(ãƒ—ãƒ©ã‚¹)ã€‚">
<div class="mini-ma-track">
<div class="mini-ma-zone dc-strong"></div>
<div class="mini-ma-zone dc-weak"></div>
<div class="mini-ma-zone gc-weak"></div>
<div class="mini-ma-zone gc-strong"></div>
<div class="mini-ma-center"></div>
<div class="mini-ma-marker" id="sumMaMarker"></div>
</div>
<div class="mini-ma-label kpi-bar-caption">DCå´ â† 0 â†’ GCå´</div>
</div>
</div></div>
<div class="summary-lists">
<div class="summary-card">
<div class="summary-card-title">ğŸ”¥ ãƒˆãƒ¬ãƒ³ãƒ‰ TOP5</div>
<ol class="summary-ol" id="summaryTrendList"><li class="summary-li muted">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</li></ol>
</div>
<div class="summary-card">
<div class="summary-card-title">ğŸš€ ä¸Šæ˜‡ TOP5ï¼ˆ24hï¼‰</div>
<ol class="summary-ol" id="summaryUpList"><li class="summary-li muted">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</li></ol>
</div>
<div class="summary-card">
<div class="summary-card-title">ğŸ“Š å‡ºæ¥é«˜(ã‚¢ãƒ«ãƒˆ) TOP5ï¼ˆ24hï¼‰</div>
<ol class="summary-ol" id="summaryVolAltList"><li class="summary-li muted">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</li></ol>
</div>
</div>
</section>
<section aria-label="ãŠã™ã™ã‚å–å¼•æ‰€å°ç·š" class="cta-block">
<div class="cta-inner">
<div class="cta-text">
<div class="cta-title">å–å¼•æ‰€ãŠã™ã™ã‚ï¼ˆåºƒå‘Šãƒ»PRï¼‰</div>
<div class="cta-sub">å›½å†…å–å¼•æ‰€ã‚’ç”¨é€”åˆ¥ã«æ¯”è¼ƒã€‚å…¬å¼ã‚µã‚¤ãƒˆ/ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å°ç·šã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚</div>
</div>
<div class="cta-actions">
<a class="btn primary" data-cta="top_to_adspr" data-partner="" data-placement="index_cta_block" data-pr="0" href="/ads-pr">å–å¼•æ‰€ãŠã™ã™ã‚ã‚’è¦‹ã‚‹</a>
<a class="btn" data-cta="top_to_start" data-partner="" data-placement="index_cta_block" data-pr="0" href="/start">å§‹ã‚æ–¹</a>
</div>
</div>
<div class="cta-note">â€»å½“ã‚µã‚¤ãƒˆã¯ä¸€éƒ¨ãƒªãƒ³ã‚¯ã«ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆåºƒå‘Šã‚’å«ã¿ã¾ã™ã€‚</div>
</section>
<section id="sec-trend">
<div class="section-header">
<div>
<div class="section-title">ãƒˆãƒ¬ãƒ³ãƒ‰ TOP5</div>
<div class="section-sub">CoinGeckoã®ã€Œãƒˆãƒƒãƒ—ãƒˆãƒ¬ãƒ³ãƒ‰ã€ï¼ˆAPI: /search/trendingï¼‰ï¼ã‚«ãƒ¼ãƒ‰å†…ãƒãƒ£ãƒ¼ãƒˆï¼šéå»7æ—¥ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆã‚µãƒ³ãƒ—ãƒ«é–“éš”ãƒ»ç‚¹æ•°ã¯APIä¾å­˜ï¼‰</div>
</div>
<div class="section-actions">
<a class="linkbtn" data-ga="ext_coingecko_trending" data-partner="coingecko" data-placement="index_trend_header" data-pr="0" href="https://www.coingecko.com/ja/highlights/trending-crypto" rel="noopener" target="_blank">ã‚‚ã£ã¨è¦‹ã‚‹</a>
</div>
</div>
<div class="grid" id="grid-trend"><div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div></div>
</section>
<section id="sec-gainers">
<div class="section-header">
<div>
<div class="section-title">ä¸Šæ˜‡ç‡ TOP5</div>
<div class="section-sub">ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«é™¤å¤–ï¼‹24hå‡ºæ¥é«˜5å„„å††ä»¥ä¸Šã‚’å„ªå…ˆã—ãŸ24hé¨°è½ç‡TOP5ï¼ˆæ™‚ä¾¡ç·é¡ä¸Šä½250éŠ˜æŸ„ã‹ã‚‰æŠ½å‡ºï¼‰ï¼ã‚«ãƒ¼ãƒ‰å†…ãƒãƒ£ãƒ¼ãƒˆï¼šéå»24æ™‚é–“ï¼ˆ1dï¼‰ï¼ˆã‚µãƒ³ãƒ—ãƒ«é–“éš”ãƒ»ç‚¹æ•°ã¯APIä¾å­˜ï¼‰</div>
</div>
<div class="section-actions">
<a class="linkbtn" data-ga="ext_coingecko_gainers" data-partner="coingecko" data-placement="index_gainers_header" data-pr="0" href="https://www.coingecko.com/ja/crypto-gainers-losers" rel="noopener" target="_blank">ã‚‚ã£ã¨è¦‹ã‚‹</a>
</div>
</div>
<div class="grid" id="grid-gainers"><div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div></div>
</section>
<section id="sec-volume">
<div class="section-header">
<div>
<div class="section-title">å‡ºæ¥é«˜ TOP5</div>
<div class="section-sub">24hå‡ºæ¥é«˜TOP5ï¼ˆå…¨ä½“ï¼šBTC/ETH/ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«å«ã‚€ï¼æ™‚ä¾¡ç·é¡ä¸Šä½250éŠ˜æŸ„ã‹ã‚‰æŠ½å‡ºï¼‰ï¼ã‚«ãƒ¼ãƒ‰å†…ãƒãƒ£ãƒ¼ãƒˆï¼šéå»24æ™‚é–“ï¼ˆ1dï¼‰ï¼ˆã‚µãƒ³ãƒ—ãƒ«é–“éš”ãƒ»ç‚¹æ•°ã¯APIä¾å­˜ï¼‰</div>
</div>
<div class="section-actions">
<a class="linkbtn" data-ga="ext_coingecko_high_volume" data-partner="coingecko" data-placement="index_volume_header" data-pr="0" href="https://www.coingecko.com/ja/highlights/high-volume" rel="noopener" target="_blank">ã‚‚ã£ã¨è¦‹ã‚‹</a>
</div>
</div>
<div class="grid" id="grid-volume"><div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div></div>
</section>
<section id="sec-alt-volume">
<div class="section-header">
<div>
<div class="section-title">å‡ºæ¥é«˜ï¼ˆã‚¢ãƒ«ãƒˆï¼‰TOP5</div>
<div class="section-sub">BTC/ETH/ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é™¤å¤–ã—ãŸ24hå‡ºæ¥é«˜TOP5ï¼ˆæ™‚ä¾¡ç·é¡ä¸Šä½250éŠ˜æŸ„ã‹ã‚‰æŠ½å‡ºï¼‰ï¼ã‚«ãƒ¼ãƒ‰å†…ãƒãƒ£ãƒ¼ãƒˆï¼šéå»24æ™‚é–“ï¼ˆ1dï¼‰ï¼ˆã‚µãƒ³ãƒ—ãƒ«é–“éš”ãƒ»ç‚¹æ•°ã¯APIä¾å­˜ï¼‰</div>
</div>
<div class="section-actions">
<a class="linkbtn" data-ga="ext_coingecko_high_volume_alt" data-partner="coingecko" data-placement="index_alt_volume_header" data-pr="0" href="https://www.coingecko.com/ja/highlights/high-volume" rel="noopener" target="_blank">ã‚‚ã£ã¨è¦‹ã‚‹</a>
</div>
</div>
<div class="grid" id="grid-alt-volume"><div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div></div>
</section>
<section id="sec-mcap">
<div class="section-header">
<div>
<div class="section-title">æ™‚ä¾¡ç·é¡ TOP20</div>
<div class="section-sub">æ™‚ä¾¡ç·é¡ä¸Šä½20ï¼ˆJPYï¼‰ï¼ã‚«ãƒ¼ãƒ‰å†…ãƒãƒ£ãƒ¼ãƒˆï¼šéå»7æ—¥ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆã‚µãƒ³ãƒ—ãƒ«é–“éš”ãƒ»ç‚¹æ•°ã¯APIä¾å­˜ï¼‰</div>
</div>
<div class="section-actions">
<a class="linkbtn" data-ga="ext_coingecko_home" data-partner="coingecko" data-placement="index_mcap_header" data-pr="0" href="https://www.coingecko.com/ja" rel="noopener" target="_blank">ã‚‚ã£ã¨è¦‹ã‚‹</a>
</div>
</div>
<div class="grid" id="grid-mcap"><div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div></div>
</section>
<section id="sec-overview">
<div class="section-header">
<div>
<div class="section-title">å¸‚å ´æ¦‚æ³</div>
<div class="section-sub">â€»è¿½åŠ APIãªã—ï¼šæ™‚ä¾¡ç·é¡ä¸Šä½250ï¼ˆJPYï¼‰ã‹ã‚‰ç®—å‡ºã—ãŸæ¦‚æ³</div>
</div>
<div class="section-actions">
<button class="linkbtn" id="btnOverviewToggle" type="button">è©³ç´°</button>
<a class="linkbtn" data-ga="ext_coingecko_home" data-partner="coingecko" data-placement="index_overview_header" data-pr="0" href="https://www.coingecko.com" rel="noopener" target="_blank">ã‚‚ã£ã¨è¦‹ã‚‹</a>
</div>
</div>
<div class="overview-kpi-strip" id="overviewKpiStrip">
<div class="kpi-tile">
<div class="kpi-tile-title">æ™‚ä¾¡ç·é¡ï¼ˆä¸Šä½250 / JPYï¼‰</div>
<div class="kpi-tile-big" id="kpiStripMcapMain">-</div>
<div class="kpi-tile-sub" id="kpiStripMcapSub">-</div>
</div>
<div class="kpi-tile">
<div class="kpi-tile-title">Dominanceï¼ˆä¸Šä½250ï¼‰</div>
<div class="kpi-tile-big" id="kpiStripDomMain">-</div>
<div class="kpi-tile-sub" id="kpiStripDomSub">-</div>
</div>
<div class="kpi-tile">
<div class="kpi-tile-title">å¸‚å ´ã®ä¸Šæ˜‡ä¸‹è½ï¼ˆ24hï¼‰</div>
<div class="kpi-tile-big" id="kpiStripBreadthMain">-</div>
<div class="kpi-tile-sub" id="kpiStripBreadthSub">-</div>
</div>
<div class="kpi-tile">
<div class="kpi-tile-title">å¹³å‡ / ä¸­å¤®å€¤ï¼ˆ7dï¼‰</div>
<div class="kpi-tile-big" id="kpiStripAvgMain">-</div>
<div class="kpi-tile-sub" id="kpiStripAvgSub">-</div>
</div>
<div class="kpi-tile">
<div class="kpi-tile-title">BTC RSIï¼ˆ14 / 7dï¼‰</div>
<div class="kpi-tile-big" id="kpiStripRsiMain">-</div>
<div class="kpi-tile-sub" id="kpiStripRsiSub">-</div>
</div>
<div class="kpi-tile">
<div class="kpi-tile-title">CoinRader Sentimentï¼ˆ0â€“100ï¼‰</div>
<div class="kpi-tile-big" id="kpiStripSentMain">-</div>
<div class="kpi-tile-sub" id="kpiStripSentSub">-</div>
</div>
</div>
<div class="overview is-collapsed" id="overviewWrap">
<div class="overview-card">
<div class="donut-wrap"><canvas id="domChart"></canvas></div>
<div class="dom-metrics" id="domMetrics">-</div>
<div class="overview-note">BTC / ETH / ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ« / Others ã®æ™‚ä¾¡ç·é¡æ§‹æˆæ¯”ï¼ˆå¯¾è±¡: ä¸Šä½250ã®åˆè¨ˆï¼‰</div>
</div>
<div class="overview-card">
<div class="kpi-grid">
<div class="kpi">
<div class="kpi-label">ä¸Šæ˜‡ / ä¸‹è½ï¼ˆ7dæ¨ç§» / ä¸Šä½250ï¼‰</div>
<div class="kpi-value" id="kpiBreadth">-</div>
<div aria-hidden="true" class="kpi-legend"><span class="item"><span class="dot up"></span>é’ï¼ä¸Šæ˜‡æ•°</span><span class="item"><span class="dot down"></span>èµ¤ï¼ä¸‹è½æ•°</span></div>
<div class="kpi-sub" id="kpiBreadthSub">ä¸Šä½250ã‚’å¯¾è±¡ã«ã€7æ—¥å‰ã‚’åŸºæº–ã«ã—ãŸç´¯ç©ãƒªã‚¿ãƒ¼ãƒ³ã§ã€Œä¸Šæ˜‡/ä¸‹è½/æ¨ªã°ã„ã€ã‚’åˆ¤å®šã—ã€æ—¥æ¬¡ã®æ¨ç§»ã‚’è¡¨ç¤ºï¼ˆé’ï¼ä¸Šæ˜‡ã€èµ¤ï¼ä¸‹è½ã€ç°ï¼æ¨ªã°ã„ï¼‰ã€‚è»¸ã¯è¦‹ã‚„ã™ã•ã®ãŸã‚éè¡¨ç¤ºã§ã™ã€‚</div>
<canvas class="kpi-canvas tall" id="breadthLine"></canvas>
</div>
<div class="kpi">
<div class="kpi-label">å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆ7dæ¨ç§» / ä¸Šä½250ï¼‰</div>
<div class="kpi-value" id="kpiAvgChange">-</div>
<div class="kpi-sub" id="kpiAvgSub">ä¸Šä½250ã®å„éŠ˜æŸ„ã«ã¤ã„ã¦ã€7æ—¥å‰ã®ä¾¡æ ¼ã‚’åŸºæº–(0%)ã¨ã—ã¦ç¾åœ¨ã¾ã§ã®ç´¯ç©ãƒªã‚¿ãƒ¼ãƒ³ã‚’ç®—å‡ºã—ã€ãã®å¹³å‡ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚0ã‚ˆã‚Šä¸Šã¯å¹³å‡çš„ã«ä¸Šæ˜‡ã€ä¸‹ã¯ä¸‹è½ã€‚</div>
<canvas class="kpi-canvas" id="avgLine"></canvas>
</div>
<div class="kpi">
<div class="kpi-label">BTC RSIï¼ˆ14 / 7dæ¨ç§»ï¼‰</div>
<div class="kpi-value" id="kpiRsi">-</div>
<div class="kpi-sub" id="kpiRsiSub">RSIã¯ä¾¡æ ¼ã®ä¸Šã’ä¸‹ã’ã®å¼·ã•ã‚’0ã€œ100ã§è¡¨ã™æŒ‡æ¨™ã§ã™ï¼ˆä¸€èˆ¬ã«70ä»¥ä¸Š=è²·ã‚ã‚Œã™ãã€30ä»¥ä¸‹=å£²ã‚‰ã‚Œã™ãï¼‰ã€‚BTCã®1æ™‚é–“è¶³ç›¸å½“ã®7æ—¥ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã‹ã‚‰ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</div>
<canvas class="kpi-canvas" id="rsiLine"></canvas>
</div>
<div class="kpi">
<div class="kpi-label">CoinRader Sentimentï¼ˆ0-100 / ä¸Šä½250ï¼‰</div>
<div class="kpi-value" id="kpiSentiment">-</div>
<div class="kpi-meta" id="kpiSentimentMeta">-</div>
<div class="sent-gauge-wrap">
<div aria-hidden="true" class="sent-gauge">
<svg aria-hidden="true" class="sent-gauge-svg" viewbox="0 0 220 120"></svg>
<div class="sent-gauge-needle" id="sentNeedle"></div>
<div class="sent-gauge-center"></div>
</div>
<div class="sent-gauge-side">
<div class="sent-label" id="sentLabel">-</div>
<div class="sent-desc" id="sentDesc">ä¸Šä½250ãƒ™ãƒ¼ã‚¹ã®ç‹¬è‡ªãƒ ãƒ¼ãƒ‰æŒ‡æ•°</div>
</div>
</div>
<div class="kpi-sub">ä¸Šä½250ã®ã€ŒåºƒãŒã‚Šï¼ˆä¸Šæ˜‡æ¯”ç‡ï¼‰ã€ã€Œ24hä¸­å¤®å€¤ã€ã€Œå‡ºæ¥é«˜å¤‰åŒ–ï¼ˆç›´å‰å€¤ã¨ã®æ¯”è¼ƒï¼‰ã€ã€ŒBTCãƒ‰ãƒŸãƒŠãƒ³ã‚¹å¤‰åŒ–ã€ã€ŒBTC RSIã€ã‚’åˆæˆã—ãŸç‹¬è‡ªã®å¸‚å ´ãƒ ãƒ¼ãƒ‰æŒ‡æ•°ã§ã™ã€‚</div>
<canvas class="kpi-canvas tiny" id="sentLine"></canvas>
</div>
<div class="kpi">
<div class="kpi-label">å¸‚å ´æ™‚ä¾¡ç·é¡ 24hå¤‰åŒ–ï¼ˆæ¨å®š / ä¸Šä½250ï¼‰</div>
<div class="kpi-value" id="kpiMcap24h">-</div>
<div class="kpi-sub">æ¨å®š: å„éŠ˜æŸ„ã®ç¾åœ¨æ™‚ä¾¡ç·é¡ã‚’24hé¨°è½ç‡ã§é€†ç®—ã—ã¦å‰æ—¥ã‚’æ¨å®šã—ã€å…¨ä½“ã®å¢—æ¸›ï¼ˆç‡/å·®é¡ï¼‰ã‚’ç®—å‡ºã€‚</div>
<canvas class="kpi-canvas" id="mcap24hLine"></canvas>
<div class="kpi-sub" style="opacity:.75;margin-top:6px;">â€»æ¨ç§»ã¯éå»24hï¼ˆ7dã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³æœ«å°¾ï¼‰</div>
</div>
<div class="kpi">
<div class="kpi-label">ä¸Šä½250 æ™‚ä¾¡ç·é¡åˆè¨ˆï¼ˆæ¨å®š7dæ¨ç§» / JPYï¼‰</div>
<div class="kpi-value" id="kpiTotalMcap">-</div>
<div class="kpi-sub">æ¨å®š: å„éŠ˜æŸ„ã®ç¾åœ¨ã®æ™‚ä¾¡ç·é¡Ã—(å„æ™‚ç‚¹ä¾¡æ ¼/ç¾åœ¨ä¾¡æ ¼) ã‚’åˆç®—ï¼ˆä¾›çµ¦ä¸€å®šã®è¿‘ä¼¼ï¼‰ã€‚</div>
<canvas class="kpi-canvas" id="mcapLine"></canvas>
</div>
<div class="kpi">
<div class="kpi-label">ä¸Šä½250 å‡ºæ¥é«˜åˆè¨ˆï¼ˆæ¨å®š7dæ¨ç§» / JPYï¼‰</div>
<div class="kpi-value" id="kpiTotalVol">-</div>
<div class="kpi-meta" id="kpiAltVolRatio">å‡ºæ¥é«˜ï¼ˆã‚¢ãƒ«ãƒˆï¼‰æ¯”ç‡: -</div>
<div class="kpi-sub">æ³¨æ„: å‡ºæ¥é«˜ã®å±¥æ­´ã¯ /coins/markets ã§ã¯å–ã‚Œãªã„ãŸã‚ã€ç¾åœ¨å‡ºæ¥é«˜Ã—(ä¾¡æ ¼æ¯”) ã®ç°¡æ˜“æ¨å®šï¼ˆç›®å®‰ï¼‰ã€‚æ­£ç¢ºãªå‡ºæ¥é«˜ã®æ¨ç§»ã«ã¯åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒå¿…è¦ã§ã™ã€‚</div>
<canvas class="kpi-canvas" id="volLine"></canvas>
</div>
</div>
<div class="overview-note">â€»æ¨ç§»ã‚°ãƒ©ãƒ•ã¯è¿½åŠ APIãªã—ã§ä½œã‚‹ãŸã‚ã€ä¸Šä½250ã®ã€Œ7æ—¥ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã€ç­‰ã‹ã‚‰æ¦‚ç®—ã—ã¦ã„ã¾ã™ï¼ˆç›®å®‰ï¼‰ã€‚</div>
</div>
</div>
<div class="msg" id="overviewMsg" style="display:none"></div>
</section>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  if (typeof Chart !== "undefined" && Chart.registerables) { Chart.register.apply(null, Chart.registerables); }

  // ============ CoinGecko API Keyï¼ˆé‹å–¶è€…ç”¨ï¼‰===========
  // å…¬é–‹ã‚µã‚¤ãƒˆã§ã¯å…¥åŠ›æ¬„ã‚’å‡ºã•ãªã„æ–¹ãŒUXãŒè‰¯ã„ãŸã‚ã€ã‚­ãƒ¼ã¯ã“ã“ã«å›ºå®šã—ã¦ãã ã•ã„ã€‚
  // ä¾‹: const COINGECKO_API_KEY = 'CG-xxxxxxxxxxxxxxxx';
  // â€»ã“ã®HTMLã¯é–²è¦§è€…ã«ã‚‚è¦‹ãˆã‚‹ãŸã‚ã€å°†æ¥çš„ã«ã¯Workersãƒ—ãƒ­ã‚­ã‚·ã§ã‚­ãƒ¼ã‚’éš ã™ã®ãŒæ¨å¥¨ã§ã™ã€‚
  const COINGECKO_API_KEY = '';

  // ============ Refresh / Rate-limit friendly ============
  const REFRESH_COOLDOWN_MS = 60 * 1000; // 60s
  let lastRefreshAt = 0;
  let refreshTimer = null;
  const refreshBtn = document.getElementById('refreshBtn');

  // Keep CSS var --hdr-h in sync with the actual header height (mobile: prevents top note being covered)
  function syncHeaderHeight(){
    try{
      const hdr = document.querySelector('.appHeader');
      if(!hdr) return;
      const h = Math.max(48, Math.ceil(hdr.getBoundingClientRect().height));
      document.documentElement.style.setProperty('--hdr-h', h + 'px');
    }catch(_e){}
  }


  function setStatus(text){ document.getElementById('statusPill').textContent = 'çŠ¶æ…‹: ' + text; }

  // --- Updated time pill (stay on page -> time keeps moving) ---
  function formatAgo(ts){
    if(!ts) return '';
    const d = Date.now() - ts;
    if (d < 10 * 1000) return 'ãŸã£ãŸä»Š';
    if (d < 60 * 1000) return `${Math.floor(d/1000)}ç§’å‰`;
    if (d < 60 * 60 * 1000) return `${Math.floor(d/60000)}åˆ†å‰`;
    if (d < 24 * 60 * 60 * 1000) return `${Math.floor(d/3600000)}æ™‚é–“å‰`;
    return `${Math.floor(d/86400000)}æ—¥å‰`;
  }

  function renderUpdatedPill(){
    const el = document.getElementById('updatedPill');
    if(!el) return;
    const ts = getLastFetchAt();
    if(!ts){
      el.textContent = 'æ›´æ–°: --';
      return;
    }
    const dt = new Date(ts);
    const ago = formatAgo(ts);
    el.textContent = 'æ›´æ–°: ' + dt.toLocaleString('ja-JP', { hour12:false }) + (ago ? `ï¼ˆ${ago}ï¼‰` : '');
  }

  function setUpdated(){
    // äº’æ›ç”¨ï¼šä»Šå¾Œã¯ localStorage(lastFetch) ã‚’åŸºæº–ã«è¡¨ç¤ºã™ã‚‹
    renderUpdatedPill();
  }

  function startUpdatedTicker(){
    renderUpdatedPill();
    setInterval(renderUpdatedPill, 1000);
  }

  
  // --- Auto refresh (every 3 min when tab is visible) ---
  const AUTO_REFRESH_MS = 3 * 60 * 1000;
  function startAutoRefresh(){
    let autoMs = 3 * 60 * 1000; // base 3min
    let failStreak = 0;

    const schedule = (delay) => {
      setTimeout(async () => {
        try{
          if (document.visibilityState !== 'visible'){
            schedule(autoMs);
            return;
          }

          IN_AUTO_REFRESH = true;
          await refreshData();
          IN_AUTO_REFRESH = false;

          if (LAST_HTTP_STATUS === 200){
            failStreak = 0;
            autoMs = 3 * 60 * 1000;
          } else if (LAST_HTTP_STATUS === 429 || LAST_HTTP_STATUS === 403){
            failStreak++;
            autoMs = Math.min(30 * 60 * 1000, 5 * 60 * 1000 * (2 ** Math.min(failStreak-1, 3))); // 5,10,20,30min
            setStatus('å–å¾—ãŒæ··ã¿åˆã£ã¦ã„ã¾ã™ï¼ˆä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ï¼‰');
          } else if (LAST_HTTP_STATUS && LAST_HTTP_STATUS !== 200){
            failStreak++;
            autoMs = Math.min(15 * 60 * 1000, 3 * 60 * 1000 * (2 ** Math.min(failStreak, 3))); // 3,6,12,15min
            setStatus('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒé…ã‚Œã¦ã„ã¾ã™ï¼ˆä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ï¼‰');
          } else {
            failStreak = 0;
            autoMs = 3 * 60 * 1000;
          }
        }catch(e){
          IN_AUTO_REFRESH = false;
          failStreak++;
          autoMs = Math.min(15 * 60 * 1000, 3 * 60 * 1000 * (2 ** Math.min(failStreak, 3)));
          setStatus('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒé…ã‚Œã¦ã„ã¾ã™ï¼ˆä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ï¼‰');
        }finally{
          schedule(autoMs);
        }
      }, delay);
    };

    schedule(autoMs);
  }

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// ============ Local cache (F5é€£æ‰“å¯¾ç­–) ============
const CACHE_TTL_MS = 5 * 60 * 1000;            // 5åˆ†ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å„ªå…ˆè¡¨ç¤º
const BOOT_NETWORK_COOLDOWN_MS = 25 * 1000;    // 25ç§’ä»¥å†…ã®å†èª­ã¿è¾¼ã¿ã¯ãƒãƒƒãƒˆå–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆAPIåˆ¶é™å¯¾ç­–ï¼‰
const LS_KEYS = {
  markets: "cg_marketsTop250_jpy_v1",
  trendingIds: "cg_trendingTop5_ids_v1",
  trendingSnapshot: "cg_trendingTop5_snapshot_v1",
  gainersSnapshot: "cg_gainersTop5_snapshot_v4",
  volumeSnapshot: "cg_volumeTop5_snapshot_v3",
  altVolumeSnapshot: "cg_altVolumeTop5_snapshot_v1",
  mcapSnapshot: "cg_mcapTop20_snapshot_v2",
  lastFetch: "cg_last_fetch_at_v1",
  lastAttempt: "cg_last_attempt_at_v1"
};

function lsGet(key){
  try { return localStorage.getItem(key); } catch { return null; }
}
function lsSet(key, val){
  try { localStorage.setItem(key, val); } catch {}
}
function readCache(key){
  const raw = lsGet(key);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function writeCache(key, data){
  lsSet(key, JSON.stringify({ ts: Date.now(), data }));
}
function getLastFetchAt(){
  const v = Number(lsGet(LS_KEYS.lastFetch) || "0");
  return Number.isFinite(v) ? v : 0;
}
function setLastFetchAt(){
  lsSet(LS_KEYS.lastFetch, String(Date.now()));
  try{ renderUpdatedPill(); }catch(e){}
}

function getLastAttemptAt(){
  const v = Number(lsGet(LS_KEYS.lastAttempt) || "0");
  return Number.isFinite(v) ? v : 0;
}
function setLastAttemptAt(){
  lsSet(LS_KEYS.lastAttempt, String(Date.now()));
  try{ renderUpdatedPill(); }catch(e){}
}


function coinSnapshot(c){
  if(!c) return null;
  const sp = c.sparkline_in_7d && Array.isArray(c.sparkline_in_7d.price) ? c.sparkline_in_7d.price : null;
  const spTrim = sp ? sp.filter(v => typeof v === 'number' && Number.isFinite(v)).slice(-240) : null;
  return {
    id: c.id,
    name: c.name,
    symbol: c.symbol,
    image: c.image,
    market_cap_rank: c.market_cap_rank ?? null,
    current_price: (typeof c.current_price === 'number' && Number.isFinite(c.current_price)) ? c.current_price : null,
    market_cap: (typeof c.market_cap === 'number' && Number.isFinite(c.market_cap)) ? c.market_cap : null,
    total_volume: (typeof c.total_volume === 'number' && Number.isFinite(c.total_volume)) ? c.total_volume : null,
    price_change_percentage_24h: (typeof c.price_change_percentage_24h === 'number' && Number.isFinite(c.price_change_percentage_24h)) ? c.price_change_percentage_24h : null,
    sparkline_in_7d: spTrim ? { price: spTrim } : undefined,
  };
}

function writeSnapshot(key, coins){
  try{
    const snap = (coins || []).slice(0,5).map(coinSnapshot).filter(Boolean);
    writeCache(key, snap);
  }catch(e){}
}

function normalizeSnapshotCoin(c){
  if (!c || typeof c !== 'object') return c;
  // Backward compatibility: older cached snapshots stored sparkline as `sparkline_in_7d_price` (array)
  // or `sparkline_in_7d` directly as an array.
  if (!c.sparkline_in_7d) {
    if (Array.isArray(c.sparkline_in_7d_price)) c.sparkline_in_7d = { price: c.sparkline_in_7d_price };
    else if (Array.isArray(c.sparkline)) c.sparkline_in_7d = { price: c.sparkline };
    else if (Array.isArray(c.sparkline_in_7d)) c.sparkline_in_7d = { price: c.sparkline_in_7d };
  } else if (Array.isArray(c.sparkline_in_7d)) {
    c.sparkline_in_7d = { price: c.sparkline_in_7d };
  }
  return c;
}

function readSnapshot(key){
  const cached = readCache(key);
  const snap = (cached && Array.isArray(cached.data)) ? cached.data : null;
  return Array.isArray(snap) ? snap.map(normalizeSnapshotCoin) : [];
}


  function tickRefreshButton(){
    const now = Date.now();
    const remain = Math.max(0, (lastRefreshAt + REFRESH_COOLDOWN_MS) - now);
    if (remain > 0){
      refreshBtn.disabled = true;
      refreshBtn.textContent = `æ›´æ–°ï¼ˆ${Math.ceil(remain/1000)}sï¼‰`;
    } else {
      refreshBtn.disabled = false;
      refreshBtn.textContent = 'æ›´æ–°';
    }
    // header height can change slightly on narrow screens when the button label updates
    try{ syncHeaderHeight(); }catch(_e){}}

  function markRefreshed(){
    lastRefreshAt = Date.now();
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(tickRefreshButton, 250);
    tickRefreshButton();
  }

  async function refreshData(){
    const now = Date.now();
    if (now < lastRefreshAt + REFRESH_COOLDOWN_MS){
      tickRefreshButton();
      setStatus('æ›´æ–°ã¾ã§å°‘ã—ãŠå¾…ã¡ãã ã•ã„');
      return;
    }
    setLastAttemptAt();
    await init(true);
  }

  function scrollToId(id){
    // if user navigates to Market Overview, auto-expand the detail charts
    if (id === 'sec-overview'){
      try{
        if (window.__setOverviewOpen) window.__setOverviewOpen(true);
        else {
          const ow = document.getElementById('overviewWrap');
          if (ow) ow.classList.remove('is-collapsed');
          setTimeout(()=>{ try{ renderOverview();
    renderQuickSummary(); }catch(_e){} }, 30);
        }
      }catch(_e){}
    }

    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
  }

  // ============ Fetch helpers ============
  async function cgFetch(url, options = {}){
    const headers = { ...(options.headers || {}) };
    if (COINGECKO_API_KEY) headers['x-cg-demo-api-key'] = COINGECKO_API_KEY;
    return fetch(url, { ...options, headers });
  }

  async function fetchWithTimeout(url, timeoutMs = 15000, options = {}){
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeoutMs);
    try{
      return await cgFetch(url, { ...options, signal: controller.signal });
    } finally {
      clearTimeout(timer);
    }
  }

  // 429/5xx ã‚’å°‘ã—ã ã‘ãƒªãƒˆãƒ©ã‚¤ï¼ˆRetry-Afterå¯¾å¿œï¼‰
  let LAST_HTTP_STATUS = 0;
let LAST_FETCH_ERROR = '';
let IN_AUTO_REFRESH = false;
async function fetchJsonRetry(url, {timeoutMs=15000, retries=2} = {}){
    let lastErr = null;
    for (let attempt=0; attempt<=retries; attempt++){
      try{
        const res = await fetchWithTimeout(url, timeoutMs);
        if (res.ok) return await res.json();

        let bodyText = '';
        try{ bodyText = await res.text(); }catch(e){}
        console.warn('API not ok:', res.status, url, bodyText.slice(0,200));

        if (res.status === 429 || (res.status >= 500 && res.status <= 599)){
          // Retry-After ãŒã‚ã‚Œã°å°Šé‡
          if (attempt < retries){
            const ra = res.headers.get('retry-after');
            const waitMs = ra ? (parseInt(ra,10) * 1000) : (600 * (attempt+1));
            await sleep(Math.min(waitMs, 5000));
            continue;
          }
        }

        throw new Error(`HTTP ${res.status}`);

      } catch(e){
        lastErr = e;
        if (attempt < retries){
          await sleep(500 * (attempt+1));
          continue;
        }
      }
    }
    throw lastErr || new Error('fetch failed');
  }

  function yen(n){
    if (typeof n !== 'number') return '-';
    return n.toLocaleString('ja-JP', { style:'currency', currency:'JPY', maximumFractionDigits: 0 });
  }

  function yenSigned(n){
    if (typeof n !== 'number' || !isFinite(n)) return '-';
    const sign = n > 0 ? '+' : (n < 0 ? '-' : '');
    const abs = Math.abs(n);
    const cur = abs.toLocaleString('ja-JP', { style:'currency', currency:'JPY', maximumFractionDigits: 0 });
    return sign + cur;
  }


  // compatibility alias (older versions used formatJPY)
  function formatJPY(n){
    return yen(n);
  }

  
function coinGeckoUrlFor(coin){
    const id = coin?.id;
    if (id) return `https://www.coingecko.com/en/coins/${encodeURIComponent(id)}`;
    const q = encodeURIComponent(coin?.name || coin?.symbol || '');
    return `https://www.coingecko.com/en/search?query=${q}`;
  }

  function fireCtaClick({ cta_id, placement, partner, pr, link_url }){
    console.log('fireCtaClick called', {cta_id, placement, partner, pr, link_url, gtag: typeof gtag});
    if (typeof gtag !== 'function') return;
    gtag('event', 'cta_click', {
      cta_id: cta_id || '',
      placement: placement || '',
      partner: partner || '',
      pr: Number(pr) || 0,
      link_url: link_url || '',
      transport_type: 'beacon',
      debug_mode: true
    });
  }

  function openCoinGecko(coin){
    const url = coinGeckoUrlFor(coin);
    window.open(url, '_blank', 'noopener');
  }

  // ============ Data ============
  let marketsTop = [];          // top250
  let trendingCoins = [];
  let summaryAvgSeries = null; // for top sparkline (avg return 7d series)

    let summaryMcapSeries = []; // session sparkline (total market cap top250)
const EXCLUDE_MCAP_IDS = new Set([
    "tether","usd-coin","dai","true-usd","first-digital-usd","ethena-usde",
    "pax-dollar","frax"
  ]);

  const EXCLUDE_MCAP_KEYWORDS = [
    "stable","tether","usd coin","us dollar"
  ];

  function isExcludedForMarketCap(c){
    const id = (c?.id || "").toLowerCase();
    const name = (c?.name || "").toLowerCase();
    const sym = (c?.symbol || "").toLowerCase();
    if (EXCLUDE_MCAP_IDS.has(id)) return true;
    return EXCLUDE_MCAP_KEYWORDS.some(k => name.includes(k) || sym.includes(k));
  }
  async function loadMarketsTop250(forceNetwork=false){
  const url = 'https://api.coingecko.com/api/v3/coins/markets'
    + '?vs_currency=jpy'
    + '&order=market_cap_desc'
    + '&per_page=250&page=1'
    + '&sparkline=true'
    + '&price_change_percentage=24h';

  // ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å³è¡¨ç¤ºï¼ˆãƒãƒƒãƒˆå¤±æ•—ã§ã‚‚ã€ŒçœŸã£ç™½ã€ã‚’é¿ã‘ã‚‹ï¼‰
  const cached = readCache(LS_KEYS.markets);
  if (cached && Array.isArray(cached.data) && cached.data.length){
    marketsTop = cached.data;
  }

  // F5é€£æ‰“ãªã©çŸ­æ™‚é–“ã®å†èª­ã¿è¾¼ã¿ã¯ãƒãƒƒãƒˆå–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆAPIåˆ¶é™å¯¾ç­–ï¼‰
  const now = Date.now();
  const lastFetchAt = getLastFetchAt();
  const canSkipNetwork = !forceNetwork && (now - lastFetchAt) < BOOT_NETWORK_COOLDOWN_MS;
  if (canSkipNetwork && marketsTop.length){
    setStatus('ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ï¼ˆè‡ªå‹•ã§æœ€æ–°ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ï¼‰');
    return;
  }

  try{
    const fresh = await fetchJsonRetry(url, {retries:2});
    if (Array.isArray(fresh) && fresh.length){
      marketsTop = fresh;
      writeCache(LS_KEYS.markets, fresh);
      setLastFetchAt();
    } else if (!Array.isArray(marketsTop) || !marketsTop.length){
      marketsTop = [];
    }
  } catch (e){
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹ãªã‚‰ãã‚Œã§ç¶™ç¶šã€‚ç„¡ã„ãªã‚‰ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
    if (marketsTop && marketsTop.length){
      console.warn('markets fetch failed, using cache:', e);
      setStatus('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒé…ã‚Œã¦ã„ã¾ã™ï¼ˆä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ï¼‰');
      return;
    }
    throw e;
  }
}


  
  // BTC MA cross (SMA50/SMA200) ç”¨ãƒ‡ãƒ¼ã‚¿
  window.__btcMaCross = null;

  async function loadBtcMaCross(){
    // CoinGeckoã®market_chartã¯è¿‘å¹´ã€Publicãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã¨æœŸé–“åˆ¶é™/ CORSã§å¤±æ•—ã—ã‚„ã™ã„ã€‚
    // ãã“ã§ã€Œè¿½åŠ APIãªã—ã€ã®ç¯„å›²ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å–å¾—ã§ãã‚‹Binanceã®OHLC(æ—¥è¶³)ã§ 50/200MA ã‚’æ¨å®šã™ã‚‹ã€‚
    // â€»ä¾¡æ ¼é€šè²¨ã¯USDTã ãŒã€MAè·é›¢(%)ã¯é€šè²¨ã«ä¾å­˜ã—ãªã„ãŸã‚å•é¡Œãªã—ã€‚
    const url = 'https://api.binance.com/api/v3/klines'
      + '?symbol=BTCUSDT'
      + '&interval=1d'
      + '&limit=260'; // 200MA + 50MA + å°‘ã—ä½™è£•

    const rows = await fetchJsonRetry(url, {retries:2});
    if (!Array.isArray(rows) || rows.length < 210) throw new Error('binance klines too short');

    // closeä¾¡æ ¼ï¼ˆindex 4ï¼‰
    const closes = rows.map(r => +r[4]).filter(v => isFinite(v) && v > 0);
    if (closes.length < 210) throw new Error('binance closes invalid');

    const sma = (arr, n) => {
      const a = arr.slice(-n);
      const s = a.reduce((x,y)=>x+y,0);
      return s / n;
    };

    const sma50 = sma(closes, 50);
    const sma200 = sma(closes, 200);
    const distPct = (sma50 - sma200) / sma200 * 100;

    const near = Math.abs(distPct) <= 0.30; // 0.3%ä»¥å†…ã‚’ã€Œè¿‘ã„ã€ç›®å®‰
    const label = near ? 'ã‚¯ãƒ­ã‚¹ä»˜è¿‘' : (distPct > 0 ? 'GCå´' : 'DCå´');

    window.__btcMaCross = {
      sma50, sma200, distPct,
      label,
      updatedAt: Date.now(),
    };
  }


async function loadTrendingTop5(forceNetwork=false){
  const trendUrl = 'https://api.coingecko.com/api/v3/search/trending';

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆids + æœ€å°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ã‹ã‚‰å…ˆã«çµ„ã¿ç«‹ã¦
  function setFromCache(ids, snap){
    const idsArr = Array.isArray(ids) ? ids : (Array.isArray(snap) ? snap.map(x => x && x.id).filter(Boolean) : []);
    if (!idsArr.length){ trendingCoins = []; return; }

    const byIdTop = new Map(marketsTop.map(x => [x.id, x]));
    const byIdSnap = new Map((Array.isArray(snap) ? snap : []).filter(Boolean).map(x => [x.id, x]));

    trendingCoins = idsArr
      .map(id => byIdTop.get(id) || byIdSnap.get(id))
      .filter(Boolean);
  }

  const cachedIdsObj = readCache(LS_KEYS.trendingIds);
  const cachedSnapObj = readCache(LS_KEYS.trendingSnapshot);
  const cachedIds = (cachedIdsObj && Array.isArray(cachedIdsObj.data)) ? cachedIdsObj.data : null;
  const cachedSnap = (cachedSnapObj && Array.isArray(cachedSnapObj.data)) ? cachedSnapObj.data : null;

  const cachedIdsCount = cachedIds ? cachedIds.length : 0;
  const cachedSnapCount = cachedSnap ? cachedSnap.length : 0;

  if (cachedIdsCount || cachedSnapCount){
    setFromCache(cachedIds, cachedSnap);
  }

  // markets ãŒå–ã‚Œã¦ã„ãªã„å ´åˆã¯ç„¡ç†ã«é€²ã‚ãªã„
  if (!marketsTop.length){
    trendingCoins = [];
    return;
  }

  // F5é€£æ‰“ãªã©çŸ­æ™‚é–“ã®å†èª­ã¿è¾¼ã¿ã¯ãƒãƒƒãƒˆå–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆAPIåˆ¶é™å¯¾ç­–ï¼‰
  const now = Date.now();
  const lastFetchAt = getLastFetchAt();
  const canSkipNetwork = !forceNetwork && (now - lastFetchAt) < BOOT_NETWORK_COOLDOWN_MS;

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥IDsã‹ã‚‰çµ„ã¿ç«‹ã¦ãŸçµæœãŒ5ä»¶æœªæº€ï¼ˆï¼top250ã«ç„¡ã„éŠ˜æŸ„ãŒæ··ã–ã£ã¦ã„ã‚‹ç­‰ï¼‰ã®å ´åˆã¯ã€
  // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã§ã‚‚ãƒãƒƒãƒˆå–å¾—ã‚’è¡Œã£ã¦æ¬ ã‘ã‚’åŸ‹ã‚ã‚‹
  const wantCount = Math.min(5, cachedIdsCount || cachedSnapCount || 5);
  const hasAllCached = trendingCoins.length >= wantCount;

  if (canSkipNetwork && hasAllCached){
    return;
  }

  try{
    const trendJson = await fetchJsonRetry(trendUrl, {retries:2});
    // NOTE: /search/trending ã®å…ˆé ­5ä»¶ã«æ¬ æ(item/idãªã—)ãŒæ··ã–ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€
    // idãŒã‚ã‚‹ã‚‚ã®ã ã‘ã‚’æ‹¾ã£ã¦ã‹ã‚‰ä¸Šä½5ä»¶ã«çµã‚‹ï¼ˆ#5ãŒæ¬ ã‘ã‚‹å•é¡Œã®å¯¾ç­–ï¼‰
    const trendItems = (trendJson.coins || [])
      .map(c => c.item)
      .filter(it => it && it.id)
      .slice(0,5);

    const ids = trendItems.map(it => it.id);

    if (!ids.length){ trendingCoins = []; return; }

    // top250 ã‹ã‚‰æ‹¾ã†
    const byIdTop = new Map(marketsTop.map(x => [x.id, x]));

    // ä¸è¶³ãŒã‚ã‚Œã°ã€ãã®idsã ã‘ markets ã§1å›å–å¾—ï¼ˆæœ€å°ï¼‰
    const missing = ids.filter(id => !byIdTop.has(id));
    if (missing.length){
      const mUrl = 'https://api.coingecko.com/api/v3/coins/markets'
        + '?vs_currency=jpy'
        + '&ids=' + encodeURIComponent(missing.join(','))
        + '&sparkline=true'
        + '&price_change_percentage=24h';
      const extra = await fetchJsonRetry(mUrl, {retries:2});
      const extraArr = Array.isArray(extra) ? extra : [];
      for (const x of extraArr) byIdTop.set(x.id, x);
    }

    // ãã‚Œã§ã‚‚ markets ãŒå–ã‚Œãªã„IDã¯ã€trendingãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® item/data ã‹ã‚‰æœ€å°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦è¡¨ç¤ºã™ã‚‹
    const fallbackById = new Map(trendItems.map(it => [it.id, it]));
    trendingCoins = ids.map(id => {
      const m = byIdTop.get(id);
      if (m) return m;

      const it = fallbackById.get(id);
      if (!it) return null;

      // trending ã® data ã¯å½¢å¼ãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€é˜²å¾¡çš„ã«æ‹¾ã†
      const data = it.data || {};
      const spark = Array.isArray(data.sparkline) ? data.sparkline
        : (data.sparkline_in_7d && Array.isArray(data.sparkline_in_7d.price) ? data.sparkline_in_7d.price : null);

      // price_change_percentage_24h ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ jpy ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æœ€åˆã®æ•°å€¤ã‚’æ‹¾ã†
      let pch = null;
      const pchAny = data.price_change_percentage_24h;
      if (typeof pchAny === 'number') pch = pchAny;
      else if (pchAny && typeof pchAny === 'object'){
        if (typeof pchAny.jpy === 'number') pch = pchAny.jpy;
        else {
          for (const v of Object.values(pchAny)){
            if (typeof v === 'number'){ pch = v; break; }
          }
        }
      }

      // price / volume ã¯é€šè²¨åˆ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã“ã¨ãŒã‚ã‚‹ï¼ˆjpyå„ªå…ˆï¼‰
      const pickNum = (x) => {
        if (typeof x === 'number') return x;
        if (x && typeof x === 'object'){
          if (typeof x.jpy === 'number') return x.jpy;
          for (const v of Object.values(x)){
            if (typeof v === 'number') return v;
          }
        }
        return null;
      };

      const price = pickNum(data.price);
      const vol = pickNum(data.total_volume);

      return {
        id,
        name: it.name || id,
        symbol: it.symbol || '',
        image: it.small || it.thumb || '',
        market_cap_rank: it.market_cap_rank || null,
        current_price: price,
        total_volume: vol,
        price_change_percentage_24h: pch,
        // Chart.js ã®æç”»ç³»ãŒæœŸå¾…ã™ã‚‹å½¢ã«åˆã‚ã›ã‚‹
        sparkline_in_7d: spark ? { price: spark } : undefined,
      };
    }).filter(Boolean);

    writeCache(LS_KEYS.trendingIds, ids);

    // æœ€å°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚‚ä¿å­˜ï¼ˆTOP250å¤–ã®éŠ˜æŸ„ã§ã‚‚æ¬¡å›F5ã§5ä»¶ã‚’ç¶­æŒã™ã‚‹ãŸã‚ï¼‰
    const snap = (trendingCoins || []).slice(0,5).map(c => {
      const sp = c && c.sparkline_in_7d && Array.isArray(c.sparkline_in_7d.price) ? c.sparkline_in_7d.price : null;
      // localStorageè‚¥å¤§åŒ–ã‚’é˜²ããŸã‚ã€ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã¯æœ«å°¾æœ€å¤§240ç‚¹ã ã‘ä¿æŒ
      const spTrim = sp ? sp.filter(v => typeof v === 'number' && Number.isFinite(v)).slice(-240) : null;
      return {
        id: c.id,
        name: c.name,
        symbol: c.symbol,
        image: c.image,
        market_cap_rank: c.market_cap_rank ?? null,
        current_price: (typeof c.current_price === 'number' && Number.isFinite(c.current_price)) ? c.current_price : null,
        total_volume: (typeof c.total_volume === 'number' && Number.isFinite(c.total_volume)) ? c.total_volume : null,
        price_change_percentage_24h: (typeof c.price_change_percentage_24h === 'number' && Number.isFinite(c.price_change_percentage_24h)) ? c.price_change_percentage_24h : null,
        sparkline_in_7d: spTrim ? { price: spTrim } : undefined,
      };
    });
    writeCache(LS_KEYS.trendingSnapshot, snap);
  } catch (e){
    if (trendingCoins && trendingCoins.length){
      console.warn('trending fetch failed, using cache/top:', e);
      return;
    }
    throw e;
  }
}

function buildMarketCapTop20(){
    // æ™‚ä¾¡ç·é¡ã¯å…¨ä½“ï¼ˆã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«å«ã‚€ï¼‰
    return marketsTop
      .filter(c => typeof c.market_cap === "number")
      .slice(0,20);
  }

function getMarketCapTop20(){
  if (marketsTop && marketsTop.length){
    const coins = buildMarketCapTop20();
    // mcapã¯20ä»¶ãªã®ã§ã€sparklineã¯ä¿å­˜ã›ãšï¼ˆå®¹é‡ç¯€ç´„ï¼‰ã€‚å¿…è¦ãªã‚‰ã“ã“ã§è¿½åŠ å¯ã€‚
    try{
      const snap = (coins || []).slice(0,20).map(c => {
        if(!c) return null;
        return {
          id: c.id,
          name: c.name,
          symbol: c.symbol,
          image: c.image,
          market_cap_rank: c.market_cap_rank ?? null,
          current_price: (typeof c.current_price === 'number' && Number.isFinite(c.current_price)) ? c.current_price : null,
          market_cap: (typeof c.market_cap === 'number' && Number.isFinite(c.market_cap)) ? c.market_cap : null,
          total_volume: (typeof c.total_volume === 'number' && Number.isFinite(c.total_volume)) ? c.total_volume : null,
          price_change_percentage_24h: (typeof c.price_change_percentage_24h === 'number' && Number.isFinite(c.price_change_percentage_24h)) ? c.price_change_percentage_24h : null,
        };
      }).filter(Boolean);
      writeCache(LS_KEYS.mcapSnapshot, snap);
    }catch(e){}
    return coins;
  }
  const cached = readCache(LS_KEYS.mcapSnapshot);
  const snap = (cached && Array.isArray(cached.data)) ? cached.data : null;
  return Array.isArray(snap) ? snap : [];
}

  // ä¸Šæ˜‡ç‡ãƒã‚¤ã‚ºå¯¾ç­–ï¼š24hå‡ºæ¥é«˜ ä¸‹é™ï¼ˆâ€»marketsTopã¯ vs_currency=jpy ãªã®ã§ total_volume ã‚‚JPYï¼‰
  const MIN_GAINERS_24H_VOLUME_JPY = 500_000_000; // ä¾‹ï¼š5å„„å††ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰


  // ===== Ranking rules (stable / major) =====
  const STABLE_IDS = new Set([
    "tether","usd-coin","dai","true-usd","first-digital-usd","ethena-usde",
    "frax","pax-dollar","paypal-usd","gemini-dollar","paxos-standard","binance-usd","liquity-usd"
  ]);
  const STABLE_SYMBOLS = new Set([
    "usdt","usdc","dai","tusd","usde","fdusd","pyusd","gusd","usdp","busd","lusd","frax"
  ]);
  function isStableCoin(c){
    const id = (c?.id || "").toLowerCase();
    const sym = (c?.symbol || "").toLowerCase();
    const name = (c?.name || "").toLowerCase();
    if (STABLE_IDS.has(id) || STABLE_SYMBOLS.has(sym)) return true;
    // fallback heuristic (è»½ã‚)
    if (name.includes("stable") && (name.includes("usd") || sym.includes("usd"))) return true;
    return false;
  }
  function isBtcOrEth(c){
    const id = (c?.id || "").toLowerCase();
    const sym = (c?.symbol || "").toLowerCase();
    return id === "bitcoin" || id === "ethereum" || sym === "btc" || sym === "eth";
  }

  function buildGainersTop5(){
    // ãƒ™ãƒ¼ã‚¹æ¡ä»¶ï¼š24hé¨°è½ç‡ãŒå–ã‚Œã‚‹ & ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«é™¤å¤–
    const base = marketsTop
      .filter(c => typeof c.price_change_percentage_24h === 'number' && Number.isFinite(c.price_change_percentage_24h))
      .filter(c => !isStableCoin(c));

    // å„ªå…ˆï¼šå‡ºæ¥é«˜ä¸‹é™ã‚’æº€ãŸã™éŠ˜æŸ„ã‹ã‚‰ä¸Šæ˜‡ç‡TOP5
    const primary = base
      .filter(c => typeof c.total_volume === 'number' && Number.isFinite(c.total_volume))
      .filter(c => c.total_volume >= MIN_GAINERS_24H_VOLUME_JPY)
      .slice()
      .sort((a,b) => b.price_change_percentage_24h - a.price_change_percentage_24h);

    if (primary.length >= 5) return primary.slice(0,5);

    // ä¸è¶³æ™‚ï¼šå‡ºæ¥é«˜ä¸‹é™ãªã—ã®å€™è£œã§è£œå®Œï¼ˆå‡ºæ¥é«˜ãŒåšã„é †ã§å®‰å…¨å¯„ã‚Šã«åŸ‹ã‚ã‚‹ï¼‰
    const picked = new Set(primary.map(x => x.id));
    const fallback = base
      .filter(c => typeof c.total_volume === 'number' && Number.isFinite(c.total_volume))
      .slice()
      .sort((a,b) => (b.total_volume || 0) - (a.total_volume || 0));

    for (const c of fallback){
      if (primary.length >= 5) break;
      if (!picked.has(c.id)){
        primary.push(c);
        picked.add(c.id);
      }
    }
    return primary.slice(0,5);
  }


  const EXCLUDE_VOLUME_IDS = new Set([
    "tether","usd-coin","dai","true-usd","first-digital-usd","ethena-usde",
    "wrapped-bitcoin","staked-ether"
  ]);

  const EXCLUDE_NAME_KEYWORDS = [
    "usd","us dollar","stable","tether","usd coin",
    "wrapped","bridged","wormhole","portal",
    "staked","staking","restaked",
    "wbtc","weth","steth"
  ];

  function isExcludedForAltVolume(c){
    const id = (c?.id || "").toLowerCase();
    const name = (c?.name || "").toLowerCase();
    const sym = (c?.symbol || "").toLowerCase();
    if (EXCLUDE_VOLUME_IDS.has(id)) return true;
    return EXCLUDE_NAME_KEYWORDS.some(k => name.includes(k) || sym.includes(k));
  }

  function buildVolumeTop5(){
    // å…¨ä½“ï¼ˆBTC/ETH/ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«å«ã‚€ï¼‰
    return marketsTop
      .filter(c => typeof c.total_volume === "number")
      .slice()
      .sort((a,b) => b.total_volume - a.total_volume)
      .slice(0,5);
  }

  function buildAltVolumeTop5(){
    // ã‚¢ãƒ«ãƒˆï¼šBTC/ETH/ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é™¤å¤–
    return marketsTop
      .filter(c => typeof c.total_volume === "number")
      .filter(c => !isStableCoin(c))
      .filter(c => !isBtcOrEth(c))
      .slice()
      .sort((a,b) => b.total_volume - a.total_volume)
      .slice(0,5);
  }
function getGainersTop5(){
  if (marketsTop && marketsTop.length){
    const coins = buildGainersTop5();
    writeSnapshot(LS_KEYS.gainersSnapshot, coins);
    return coins;
  }
  return readSnapshot(LS_KEYS.gainersSnapshot);
}

function getVolumeTop5(){
  if (marketsTop && marketsTop.length){
    const coins = buildVolumeTop5();
    writeSnapshot(LS_KEYS.volumeSnapshot, coins);
    return coins;
  }
  return readSnapshot(LS_KEYS.volumeSnapshot);
}



function getAltVolumeTop5(){
  if (marketsTop && marketsTop.length){
    const coins = buildAltVolumeTop5();
    writeSnapshot(LS_KEYS.altVolumeSnapshot, coins);
    return coins;
  }
  return readSnapshot(LS_KEYS.altVolumeSnapshot);
}

  // ============ Market Overview ============

  function fmtPct(n){
    if (typeof n !== 'number' || !isFinite(n)) return '-';
    const s = (n>=0?'+':'');
    return s + n.toFixed(2) + '%';
  }


  // ===== Summary mini visuals (v68) =====
  function updateSummaryRsiBar(val){
    const marker = document.getElementById('sumRsiMarker');
    if(!marker) return;
    if(typeof val !== 'number' || !isFinite(val)){
      marker.style.left = '50%';
      marker.style.opacity = '0.25';
      marker.style.boxShadow = '0 0 0 3px rgba(59,130,246,0.18)';
      return;
    }
    const v = Math.max(0, Math.min(100, val));
    marker.style.left = v.toFixed(1) + '%';
    marker.style.opacity = '1';
    if (v >= 70) marker.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.25)';
    else if (v <= 30) marker.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.25)';
    else marker.style.boxShadow = '0 0 0 3px rgba(59,130,246,0.25)';
  }


  function updateSummaryMaBar(distPct){
    const marker = document.getElementById('sumMaMarker');
    if (!marker) return;

    if (!Number.isFinite(distPct)) {
      marker.style.left = '50%';
      marker.style.opacity = '0.35';
      marker.style.boxShadow = '0 0 0 3px rgba(59,130,246,0.18)';
      return;
    }

    const range = 5; // Â±5% ã‚’è¡¨ç¤ºãƒ¬ãƒ³ã‚¸ã«ï¼ˆè¶…éã¯ã‚¯ãƒ©ãƒ³ãƒ—ï¼‰
    const d = Math.max(-range, Math.min(range, distPct));
    const left = (d + range) / (2 * range) * 100;
    marker.style.left = `${left}%`;
    marker.style.opacity = '1';

    // è‰²å‘³ã¯ã€Œå±é™ºâ†’å®‰å…¨ï¼ˆèµ¤â†’é»„â†’é’â†’ç·‘ï¼‰ã€ã«åˆã‚ã›ã‚‹ï¼ˆæ„å‘³ã¯DC/GCï¼‰
    if (d <= -range * 0.5) marker.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.22)';        // DCå¼·
    else if (d < 0)        marker.style.boxShadow = '0 0 0 3px rgba(245,158,11,0.22)';        // DCå¼±
    else if (d <  range*0.5) marker.style.boxShadow = '0 0 0 3px rgba(59,130,246,0.22)';      // GCå¼±
    else                   marker.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.22)';         // GCå¼·
  }


  function updateSummarySentBar(val){
    const marker = document.getElementById('sumSentMarker');
    if(!marker) return;
    if(typeof val !== 'number' || !isFinite(val)){
      marker.style.left = '50%';
      marker.style.opacity = '0.25';
      marker.style.boxShadow = '0 0 0 3px rgba(59,130,246,0.18)';
      return;
    }
    const v = Math.max(0, Math.min(100, val));
    marker.style.left = v.toFixed(1) + '%';
    marker.style.opacity = '1';
    if (v >= 75) marker.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.22)';
    else if (v <= 25) marker.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.22)';
    else if (v >= 50) marker.style.boxShadow = '0 0 0 3px rgba(148,163,184,0.22)';
    else marker.style.boxShadow = '0 0 0 3px rgba(245,158,11,0.22)';
  }
  function updateSummaryDomBar(pcts){
    const elB = document.getElementById('sumDomSegBtc');
    const elE = document.getElementById('sumDomSegEth');
    const elS = document.getElementById('sumDomSegStb');
    const elO = document.getElementById('sumDomSegOth');
    if (!elB || !elE || !elS || !elO) return;

    const pct = Array.isArray(pcts) ? pcts : [0,0,0,0];
    const clamp = (v)=> Math.max(0, Math.min(100, Number(v)||0));
    const b = clamp(pct[0]), e = clamp(pct[1]), s = clamp(pct[2]), o = clamp(pct[3]);
    const total = b + e + s + o || 1;
    const nb = b/total*100, ne = e/total*100, ns = s/total*100, no = o/total*100;

    let left = 0;
    const setSeg = (el, w)=>{
      el.style.left = `${left}%`;
      el.style.width = `${Math.max(0, w)}%`;
      left += w;
    };
    setSeg(elB, nb);
    setSeg(elE, ne);
    setSeg(elS, ns);
    setSeg(elO, Math.max(0, 100 - (nb+ne+ns))); // èª¤å·®å¸å
  }

  function updateSummaryAvgSpark(arr){
    const line = document.getElementById('sumAvgSparkLine');
    const fill = document.getElementById('sumAvgSparkFill');
    const zero = document.getElementById('sumAvgSparkZero');
    if(!line || !fill || !zero) return;

    if(!Array.isArray(arr) || arr.length < 2){
      line.setAttribute('points','');
      fill.setAttribute('d','');
      zero.style.display = 'none';
      return;
    }
    // use latest 60 points for speed
    const raw = arr.slice(-60).map(v => +v).filter(v => isFinite(v));
    if(raw.length < 2){
      line.setAttribute('points','');
      fill.setAttribute('d','');
      zero.style.display = 'none';
      return;
    }
    let min = Math.min(...raw);
    let max = Math.max(...raw);
    if(min === max){ min -= 1; max += 1; }

    const W = 100, H = 30, pad = 2;
    const top = pad, bottom = H - pad;

    const pts = raw.map((v,i)=>{
      const x = (i/(raw.length-1)) * W;
      const y = bottom - ((v - min)/(max - min)) * (bottom - top);
      return [x,y];
    });

    const points = pts.map(p => `${p[0].toFixed(2)},${p[1].toFixed(2)}`).join(' ');
    line.setAttribute('points', points);

    const path = `M ${pts[0][0].toFixed(2)} ${bottom.toFixed(2)} L ${pts.map(p=>`${p[0].toFixed(2)} ${p[1].toFixed(2)}`).join(' L ')} L ${pts[pts.length-1][0].toFixed(2)} ${bottom.toFixed(2)} Z`;
    fill.setAttribute('d', path);

    const zy = bottom - ((0 - min)/(max - min)) * (bottom - top);
    if(zy >= top && zy <= bottom){
      zero.setAttribute('y1', zy.toFixed(2));
      zero.setAttribute('y2', zy.toFixed(2));
      zero.style.display = 'block';
    }else{
      zero.style.display = 'none';
    }
  }

  function updateSummaryMcapSpark(arr){
    const line = document.getElementById('sumMcapSparkLine');
    const fill = document.getElementById('sumMcapSparkFill');
    if(!line || !fill) return;

    if(!Array.isArray(arr) || arr.length < 2){
      line.setAttribute('points','');
      fill.setAttribute('d','');
      return;
    }
    const rawAbs = arr.slice(-60).map(v => +v).filter(v => isFinite(v));
    const base = (rawAbs.length && isFinite(rawAbs[0]) && rawAbs[0]!==0) ? rawAbs[0] : null;
    const raw = base ? rawAbs.map(v => (v/base - 1) * 100) : rawAbs;
    if(raw.length < 2){
      line.setAttribute('points','');
      fill.setAttribute('d','');
      return;
    }
    let min = Math.min(...raw);
    let max = Math.max(...raw);
    if(min === max){ min -= 0.01; max += 0.01; }

    const W = 100, H = 30, pad = 2;
    const top = pad, bottom = H - pad;

    const pts = raw.map((v,i)=>{
      const x = (i/(raw.length-1)) * W;
      const y = bottom - ((v - min)/(max - min)) * (bottom - top);
      return [x,y];
    });

    const points = pts.map(p => `${p[0].toFixed(2)},${p[1].toFixed(2)}`).join(' ');
    line.setAttribute('points', points);

    const path = `M ${pts[0][0].toFixed(2)} ${bottom.toFixed(2)} L ${pts.map(p=>`${p[0].toFixed(2)} ${p[1].toFixed(2)}`).join(' L ')} L ${pts[pts.length-1][0].toFixed(2)} ${bottom.toFixed(2)} Z`;
    fill.setAttribute('d', path);
  }


  function buildOverview(){
    const arr = marketsTop || [];
    const n = arr.length;
    let totalMcap = 0;
    let totalVol = 0;

    // 24h market cap change (estimate): reverse-calc yesterday's market cap from price change
    // Assumption: circulating supply is roughly constant over 24h.
    let prevMcapEst = 0;

    let up = 0, down = 0, flat = 0;
    let sumChg = 0, chgN = 0;
    let chgArr = [];

    // Composition (market cap)
    let btc = 0, eth = 0, stable = 0, other = 0;
    // Composition (volume)
    let btcV = 0, ethV = 0, stableV = 0, otherV = 0;

    for (const c of arr){
      const mc = (typeof c.market_cap === 'number' && isFinite(c.market_cap)) ? c.market_cap : 0;
      const vol = (typeof c.total_volume === 'number' && isFinite(c.total_volume)) ? c.total_volume : 0;
      totalMcap += mc;
      totalVol += vol;

      const chg = c.price_change_percentage_24h;
      if (typeof chg === 'number' && isFinite(chg)){
        const denom = 1 + (chg / 100);
        if (denom > 0 && isFinite(denom)) prevMcapEst += (mc / denom);
        else prevMcapEst += mc;

        if (chg > 0) up++;
        else if (chg < 0) down++;
        else flat++;
        sumChg += chg;
        chgN++;
        chgArr.push(chg);
      } else {
        // fallback: if 24h change is missing, keep it neutral (no change)
        prevMcapEst += mc;
      }

      if (c.id === 'bitcoin'){ btc += mc; btcV += vol; }
      else if (c.id === 'ethereum'){ eth += mc; ethV += vol; }
      else if (STABLE_IDS.has(c.id)){ stable += mc; stableV += vol; }
      else { other += mc; otherV += vol; }
    }

    const avgChg = chgN ? (sumChg / chgN) : null;

    let medianChg = null;
    if (chgArr.length){
      const s = chgArr.slice().sort((a,b)=>a-b);
      const mid = Math.floor(s.length / 2);
      medianChg = (s.length % 2) ? s[mid] : (s[mid-1] + s[mid]) / 2;
    }

    const labels = ['BTC','ETH','ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«','Others'];
    const values = [btc, eth, stable, Math.max(0, other)];
    const volValues = [btcV, ethV, stableV, Math.max(0, otherV)];

    const mcap24hPct = (prevMcapEst > 0) ? ((totalMcap / prevMcapEst) - 1) * 100 : null;
    const mcap24hDelta = (prevMcapEst > 0) ? (totalMcap - prevMcapEst) : null;

    return { labels, values, volValues, totalMcap, totalVol, up, down, flat, avgChg, medianChg, chgN, n, mcap24hPct, mcap24hDelta };
  }

  function drawDonut(canvasId, labels, values){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const total = values.reduce((a,b)=>a+(typeof b==='number'?b:0), 0) || 1;
    const dataVals = values.map(v => (typeof v==='number' && isFinite(v)) ? v : 0);

    // è¦‹ã‚„ã™ã„è½ã¡ç€ã„ãŸè‰²ï¼ˆã‚µã‚¤ãƒˆã®é›°å›²æ°—ã«åˆã‚ã›ã‚‹ï¼‰
    const colors = ['rgba(250, 204, 21, 0.85)','rgba(96, 165, 250, 0.85)','rgba(52, 211, 153, 0.85)','rgba(156, 163, 175, 0.55)'];

    charts[canvasId] = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{ data: dataVals, backgroundColor: colors, borderWidth: 0 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#e5e7eb', boxWidth: 10, padding: 12 }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const v = ctx.parsed || 0;
                const p = (v/total)*100;
                return ` ${ctx.label}: ${p.toFixed(2)}%`;
              }
            }
          }
        }
      }
    });
  }

  function renderOverview(){
    const msg = document.getElementById('overviewMsg');
    msg.style.display = 'none';

    // reset mini series cache each run
    summaryAvgSeries = null;

    if (!marketsTop || !marketsTop.length){
      msg.className = 'msg err';
      msg.textContent = 'æ¦‚æ³ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­ã§ã™ã€‚';
      msg.style.display = 'block';
      return;
    }

    const o = buildOverview();

    const wrap = document.getElementById('overviewWrap');
    const isCollapsed = wrap && wrap.classList.contains('is-collapsed');

    let lastUp = null, lastDown = null;
    let avg7 = null, med7 = null;
    let sentScore = null, sentLabel = null;
    let lastRsiVal = null;

    // Breadth
    const denom = (o.up + o.down + o.flat) || 1;
    const upPct = (o.up / denom) * 100;
    const flatPct = (o.flat / denom) * 100;
    const downPct = (o.down / denom) * 100;

    const breadthEl = document.getElementById('kpiBreadth');
    if (breadthEl){
      breadthEl.textContent = `ä¸Šæ˜‡ ${o.up} / ä¸‹è½ ${o.down}ï¼ˆä¸Šæ˜‡ç‡ ${upPct.toFixed(1)}%ï¼‰`;
    }

    const breadthSub = document.getElementById('kpiBreadthSub');
    if (breadthSub){
      const baseTxt = `å¯¾è±¡: ä¸Šä½250ï¼ˆå–å¾— ${o.n}ï¼‰ã®ã†ã¡ã€24hé¨°è½ç‡ãŒå–å¾—ã§ããŸ ${o.chgN} éŠ˜æŸ„ã‚’é›†è¨ˆ`;
      const flatTxt = (o.flat > 0) ? `ï¼ˆä¸­ç«‹ ${o.flat}ï¼‰` : '';
      breadthSub.textContent = `${baseTxt}${flatTxt}`;
    }

    const barUp = document.getElementById('barUp');
    const barFlat = document.getElementById('barFlat');
    const barDown = document.getElementById('barDown');
    if (barUp) barUp.style.width = `${upPct}%`;
    if (barFlat) barFlat.style.width = `${flatPct}%`;
    if (barDown) barDown.style.width = `${downPct}%`;

    // Average change
    const avgEl = document.getElementById('kpiAvgChange');
    if (avgEl){
      avgEl.textContent = `å¹³å‡ ${fmtPct(o.avgChg)} / ä¸­å¤®å€¤ ${fmtPct(o.medianChg)}`;
    }
    const avgFill = document.getElementById('avgFill');
    if (avgFill){
      const maxRange = 5; // Â±5% ã‚’ç›®å®‰ã«å¯è¦–åŒ–ï¼ˆè¶…éã¯ã‚¯ãƒªãƒƒãƒ—ï¼‰
      const v = (typeof o.avgChg === 'number' && isFinite(o.avgChg)) ? o.avgChg : 0;
      const w = Math.min(Math.abs(v), maxRange) / maxRange * 50; // 0..50
      if (v >= 0){
        avgFill.className = 'centerfill pos';
        avgFill.style.left = '50%';
        avgFill.style.width = `${w}%`;
      } else {
        avgFill.className = 'centerfill neg';
        avgFill.style.left = `${50 - w}%`;
        avgFill.style.width = `${w}%`;
      }
    }

    // Totals
    document.getElementById('kpiTotalMcap').textContent = yen(o.totalMcap);
    document.getElementById('kpiTotalVol').textContent = yen(o.totalVol);

    // Market cap 24h change (estimate)
    const mcap24hEl = document.getElementById('kpiMcap24h');
    if (mcap24hEl){
      const pct = fmtPct(o.mcap24hPct);
      const delta = yenSigned(o.mcap24hDelta);
      mcap24hEl.textContent = `${pct}ï¼ˆ${delta}ï¼‰`;
    }

    // Composition bars (market cap)
    const totalM = (o.values || []).reduce((a,b)=>a+((typeof b==='number'&&isFinite(b))?b:0), 0) || 1;
    const mPct = (o.values || []).map(v => (((typeof v==='number'&&isFinite(v))?v:0)/totalM)*100);
    const setW = (id, w) => { const el = document.getElementById(id); if (el) el.style.width = `${w}%`; };
    setW('mcapSegBtc', mPct[0] || 0);
    setW('mcapSegEth', mPct[1] || 0);
    setW('mcapSegStable', mPct[2] || 0);
    setW('mcapSegOther', mPct[3] || 0);

    // Composition bars (volume)
    const totalV = (o.volValues || []).reduce((a,b)=>a+((typeof b==='number'&&isFinite(b))?b:0), 0) || 1;
    const vPct = (o.volValues || []).map(v => (((typeof v==='number'&&isFinite(v))?v:0)/totalV)*100);
    const altRatio = ((((o.volValues || [])[3] || 0) * 1) / totalV) * 100;
    const elAltRatio = document.getElementById('kpiAltVolRatio');
    if (elAltRatio) elAltRatio.textContent = `å‡ºæ¥é«˜ï¼ˆã‚¢ãƒ«ãƒˆï¼‰æ¯”ç‡: ${isFinite(altRatio) ? altRatio.toFixed(1) : '-'}%`;
    setW('volSegBtc', vPct[0] || 0);
    setW('volSegEth', vPct[1] || 0);
    setW('volSegStable', vPct[2] || 0);
    setW('volSegOther', vPct[3] || 0);



    // ---- Overview line series (APIè¿½åŠ ãªã—: sparkline_in_7d ã‹ã‚‰ç®—å‡º) ----
    try {
      const seriesLen = (marketsTop && marketsTop[0] && marketsTop[0].sparkline_in_7d && marketsTop[0].sparkline_in_7d.price) ? marketsTop[0].sparkline_in_7d.price.length : 0;
      if (seriesLen > 2) {
        const upArr = new Array(seriesLen).fill(0);
        const downArr = new Array(seriesLen).fill(0);
        const flatArr = new Array(seriesLen).fill(0);
        const avgArr = new Array(seriesLen).fill(0);
        const mcapArr = new Array(seriesLen).fill(0);
        const volArr = new Array(seriesLen).fill(0);
        const cntArr = new Array(seriesLen).fill(0);
        const lastRets = []; // latest-point 7d returns for median

        for (let i=0;i<marketsTop.length;i++){
          const c = marketsTop[i];
          const sp = c && c.sparkline_in_7d && c.sparkline_in_7d.price;
          if (!sp || sp.length !== seriesLen) continue;
          const p0 = sp[0];
          const plast = sp[seriesLen-1];
          if (!(p0>0) || !(plast>0)) continue;
          const mcNow = (typeof c.market_cap === 'number' && isFinite(c.market_cap)) ? c.market_cap : 0;
          const volNow = (typeof c.total_volume === 'number' && isFinite(c.total_volume)) ? c.total_volume : 0;

          // latest 7d return for median (from first available price to latest)
          const retLast = (plast / p0 - 1) * 100;
          if (isFinite(retLast)) lastRets.push(retLast);
          for (let t=0;t<seriesLen;t++){
            const pt = sp[t];
            if (!(pt>0)) continue;
            const ret = (pt/p0 - 1) * 100;
            if (ret > 0) upArr[t] += 1;
            else if (ret < 0) downArr[t] += 1;
            else flatArr[t] += 1;
            avgArr[t] += ret;
            cntArr[t] += 1;
            // æ¨å®š: supplyä¸€å®šè¿‘ä¼¼
            if (mcNow>0) mcapArr[t] += mcNow * (pt/plast);
            if (volNow>0) volArr[t] += volNow * (pt/plast);
          }
        }
        for (let t=0;t<seriesLen;t++){
          if (cntArr[t]>0) avgArr[t] = avgArr[t] / cntArr[t];
        }
        summaryAvgSeries = avgArr.slice();
        // Labels: just indexes (Chart.js will hide axis anyway)
        const labels = Array.from({length: seriesLen}, (_,i)=>i);

        // Breadth chart (3 lines)
        makeLineChart('breadthLine', labels, [
          {label:'ä¸Šæ˜‡', data: upArr, border:'rgba(30,136,229,0.9)', fill:false},
          {label:'ä¸‹è½', data: downArr, border:'rgba(211,47,47,0.9)', fill:false},
          {label:'ä¸­ç«‹', data: flatArr, border:'rgba(156,163,175,0.7)', fill:false},
        ], {yBeginAtZero:true});

        // Avg return chart (0 baseline fill)
        makeBaselineChart('avgLine', labels, avgArr);
        // KPIè¡¨ç¤ºã‚’ã€Œ7dæ¨ç§»ã€ãƒ™ãƒ¼ã‚¹ï¼ˆæœ€æ–°ç‚¹ï¼‰ã«åˆã‚ã›ã‚‹
        lastUp = upArr[upArr.length - 1];
        lastDown = downArr[downArr.length - 1];
        const lastAvg = avgArr[avgArr.length - 1];
        const kpiB = document.getElementById('kpiBreadth');
        if (kpiB){
          const denom = (Number(lastUp)||0) + (Number(lastDown)||0);
          const upPct = denom ? ((Number(lastUp)||0) / denom) * 100 : 0;
          kpiB.textContent = `ä¸Šæ˜‡ ${lastUp} / ä¸‹è½ ${lastDown}ï¼ˆä¸Šæ˜‡ç‡ ${upPct.toFixed(1)}%ï¼‰`;
        }
        const kpiAvg = document.getElementById('kpiAvgChange');
        if (kpiAvg){
          let med = null;
          if (lastRets.length){
            const s = lastRets.slice().sort((a,b)=>a-b);
            const mid = Math.floor(s.length/2);
            med = (s.length % 2) ? s[mid] : (s[mid-1] + s[mid]) / 2;
          }
          kpiAvg.textContent = `å¹³å‡ ${fmtPct(lastAvg)} / ä¸­å¤®å€¤ ${fmtPct(med)}`;
        avg7 = lastAvg;
        med7 = med;
        }


        
        // BTC RSI (14) from BTC sparkline (7d)
        try {
          const btc = marketsTop.find(c => c && c.id === 'bitcoin');
          const btcPrices = btc && btc.sparkline_in_7d && Array.isArray(btc.sparkline_in_7d.price) ? btc.sparkline_in_7d.price : null;
          if (btcPrices && btcPrices.length >= 20) {
            const rsiSeries = computeRSISeries(btcPrices, 14);
            const last = rsiSeries[rsiSeries.length - 1];
            lastRsiVal = last;
            const rsiEl = document.getElementById('kpiRsi');
            if (rsiEl && last != null && isFinite(last)) {
              let tag = 'ä¸­ç«‹';
              if (last >= 70) tag = 'è²·ã‚ã‚Œã™ã';
              else if (last <= 30) tag = 'å£²ã‚‰ã‚Œã™ã';
              rsiEl.textContent = `RSI ${last.toFixed(1)}ï¼ˆ${tag}ï¼‰`;
            }
            // use the same label length as other sparklines
            const rsiLabels = Array.from({length: rsiSeries.length}, (_, i) => i);
            makeLineChart('rsiLine', rsiLabels, [{
              label: 'RSI',
              data: rsiSeries,
              borderColor: '#a78bfa',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.35,
              fill: false
            }], { yMin: 0, yMax: 100 });
          }
        } catch(e) { console.warn('RSI failed', e); }

        // CoinRader Sentiment (0-100) â€” top250ãƒ™ãƒ¼ã‚¹
        try{
          const denomS = (Number(lastUp)||0) + (Number(lastDown)||0);
          const upPctS = denomS ? ((Number(lastUp)||0)/denomS)*100 : 0;

          // 24h change median (top250)
          const pct24 = marketsTop.map(c => (c && typeof c.price_change_percentage_24h === 'number' && isFinite(c.price_change_percentage_24h)) ? c.price_change_percentage_24h : null)
                                .filter(v => v != null);
          let med24 = null;
          if (pct24.length){
            const s = pct24.slice().sort((a,b)=>a-b);
            const mid = Math.floor(s.length/2);
            med24 = (s.length % 2) ? s[mid] : (s[mid-1] + s[mid]) / 2;
          }

          // Total volume change vs previous refresh (localStorage)
          const volNow = marketsTop.reduce((acc,c)=> acc + (Number.isFinite(c && c.total_volume)? c.total_volume : 0), 0);
          const keyVol = 'cr_prev_total_vol';
          const keyVolTs = 'cr_prev_total_vol_ts';
          const prevVol = Number(localStorage.getItem(keyVol));
          const prevVolTs = Number(localStorage.getItem(keyVolTs));
          let volChgPct = null;
          if (prevVol && isFinite(prevVol) && prevVol > 0 && prevVolTs && (Date.now() - prevVolTs) < (12*60*60*1000)){
            volChgPct = (volNow/prevVol - 1) * 100;
          }
          localStorage.setItem(keyVol, String(volNow));
          localStorage.setItem(keyVolTs, String(Date.now()));

          // BTC dominance delta (percentage point) vs previous refresh
          const totalM = (o.values||[]).reduce((a,b)=>a + (Number.isFinite(+b)? +b : 0), 0);
          const btcM = (o.values && o.values.length) ? (Number.isFinite(+o.values[0]) ? +o.values[0] : 0) : 0;
          const btcDom = totalM > 0 ? (btcM/totalM) * 100 : null;
          const keyDom = 'cr_prev_btc_dom';
          const prevDom = Number(localStorage.getItem(keyDom));
          let domDelta = null;
          if (btcDom != null && isFinite(btcDom) && prevDom && isFinite(prevDom)){
            domDelta = btcDom - prevDom;
          }
          if (btcDom != null && isFinite(btcDom)) localStorage.setItem(keyDom, String(btcDom));

          // Normalize helpers
          const clamp = (x,min,max)=> Math.max(min, Math.min(max, x));
          const normBreadth = clamp((upPctS - 50) / 50, -1, 1);             // breadth (0-100%)
          const normMed24   = (med24 == null) ? 0 : clamp(med24 / 10, -1, 1); // median24h (+/-10%)
          const normVol     = (volChgPct == null) ? 0 : clamp(volChgPct / 20, -1, 1); // volÎ” (+/-20%)
          const normDom     = (domDelta == null) ? 0 : clamp((-domDelta) / 2, -1, 1);  // domâ†“ => risk-on
          const normRsi     = (lastRsiVal == null || !isFinite(lastRsiVal)) ? 0 : clamp((lastRsiVal - 50) / 20, -1, 1);

          const raw = 0.30*normBreadth + 0.25*normMed24 + 0.20*normVol + 0.10*normDom + 0.15*normRsi;
          const score = clamp(50 + 50*raw, 0, 100);

          const label = (score>=81) ? 'æ¥µåº¦ã®å¼·æ¬²' : (score>=61) ? 'å¼·æ¬²' : (score>=41) ? 'ä¸­ç«‹' : (score>=21) ? 'ææ€–' : 'æ¥µåº¦ã®ææ€–';
          sentScore = score;
          sentLabel = label;

          const elS = document.getElementById('kpiSentiment');
          if (elS) elS.textContent = `${score.toFixed(0)}ï¼ˆ${label}ï¼‰`;

          // gauge needle + small label
          updateSentimentGauge(score, label);

          const elM = document.getElementById('kpiSentimentMeta');
          if (elM){
            const parts = [];
            parts.push(`ä¸Šæ˜‡ç‡ ${upPctS.toFixed(1)}%`);
            if (med24 != null && isFinite(med24)) parts.push(`24hä¸­å¤®å€¤ ${med24.toFixed(2)}%`);
            if (volChgPct != null && isFinite(volChgPct)) parts.push(`å‡ºæ¥é«˜Î” ${volChgPct.toFixed(1)}%`);
            if (domDelta != null && isFinite(domDelta)) parts.push(`BTC Dom Î” ${domDelta.toFixed(2)}pt`);
            if (lastRsiVal != null && isFinite(lastRsiVal)) parts.push(`RSI ${lastRsiVal.toFixed(1)}`);
            elM.textContent = parts.join(' / ');
          }

          // history sparkline (store last 120 points)
          const histKey = 'cr_sent_hist';
          let hist = [];
          try { hist = JSON.parse(localStorage.getItem(histKey) || '[]'); } catch(_){}
          if (!Array.isArray(hist)) hist = [];
          hist.push(Number(score));
          if (hist.length > 120) hist = hist.slice(-120);
          localStorage.setItem(histKey, JSON.stringify(hist));

          const labS = hist.map((_,i)=>i);
          if (charts['sentLine']) { try { charts['sentLine'].destroy(); } catch(_){} }
          makeLineChart('sentLine', labS, [{label:'Sent', data: hist, border:'rgba(96,165,250,0.9)'}], {yMin:0, yMax:100});
        }catch(e){ console.warn('sentiment failed', e); }

        // Market cap estimate (normalize to last for readability)
        makeNormalizedLine('mcapLine', labels, mcapArr);

        // Market cap last-24h spark (use tail of 7d sparkline)
        try {
          const win = Math.min(24, mcapArr.length);
          if (win >= 3) {
            makeNormalizedLine('mcap24hLine', labels.slice(-win), mcapArr.slice(-win));
          }
        } catch(_){}

        // Volume estimate (normalize)
        makeNormalizedLine('volLine', labels, volArr);
      }
    } catch(e) { console.warn('overview series failed', e); }

    drawDonut('domChart', o.labels, o.values);
    // Dominance text (BTC/ETH/ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«/Others)
    try{
      const domEl = document.getElementById('domMetrics');
      if(domEl){
        const total = (o.values||[]).reduce((a,b)=>a + (Number.isFinite(+b)? +b : 0), 0);
        if(total > 0){
          domEl.textContent = (o.labels||[]).map((lab,i)=>{
            const v = Number.isFinite(+o.values[i]) ? +o.values[i] : 0;
            return `${lab} ${(v/total*100).toFixed(1)}%`;
          }).join(' / ');
        }else{
          domEl.textContent = '-';
        }
      }
    }catch(_){}

    // è¦‹ãˆãªã„çŠ¶æ…‹ã§åˆæœŸæç”»ã•ã‚Œã‚‹ã¨å¹…0ã§ãƒãƒ£ãƒ¼ãƒˆãŒæ½°ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€æ¬¡ã®tickã§ãƒªã‚µã‚¤ã‚º

    // --- KPI strip (collapsed view) ---
    (function updateOverviewStrip(){
      const set = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = (txt==null||txt==='') ? 'â€”' : String(txt); };
      // æ™‚ä¾¡ç·é¡
      set('kpiStripMcapMain', formatJPY(o.totalMcap));
      const mcapPct = (o.mcap24hPct==null) ? null : ((o.mcap24hPct>=0?'+':'') + o.mcap24hPct.toFixed(2) + '%');
      const mcapAbs = (o.mcap24hDelta==null) ? null : formatJPY(o.mcap24hDelta);
      set('kpiStripMcapSub', (mcapPct && mcapAbs) ? `24h ${mcapPct} (${mcapAbs})` : (mcapPct||mcapAbs));

      // Dominance
      const domBTC = (o.values && o.values.length) ? (o.values[0]/o.totalMcap*100) : null;
      const domETH = (o.values && o.values.length>1) ? (o.values[1]/o.totalMcap*100) : null;
      const domSTB = (o.values && o.values.length>2) ? (o.values[2]/o.totalMcap*100) : null;
      const domOTH = (o.values && o.values.length>3) ? (o.values[3]/o.totalMcap*100) : null;
      set('kpiStripDomMain', domBTC==null ? null : `${domBTC.toFixed(1)}%`);
      const domSubParts = [];
      if(domETH!=null) domSubParts.push(`ETH ${domETH.toFixed(1)}%`);
      if(domSTB!=null) domSubParts.push(`ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ« ${domSTB.toFixed(1)}%`);
      if(domOTH!=null) domSubParts.push(`Others ${domOTH.toFixed(1)}%`);
      set('kpiStripDomSub', domSubParts.length? domSubParts.join(' / ') : null);

      // Breadth
      set('kpiStripBreadthMain', (lastUp!=null && lastDown!=null) ? `ä¸Šæ˜‡ ${lastUp} / ä¸‹è½ ${lastDown}` : null);
      const upRate = (lastUp!=null && lastDown!=null && (lastUp+lastDown)>0) ? (lastUp/(lastUp+lastDown)*100) : null;
      set('kpiStripBreadthSub', upRate==null ? null : `ä¸Šæ˜‡ç‡ ${upRate.toFixed(1)}%`);

      // Avg/Median 7d
      set('kpiStripAvgMain', avg7==null ? null : `å¹³å‡ ${avg7.toFixed(2)}%`);
      set('kpiStripAvgSub',  med7==null ? null : `ä¸­å¤®å€¤ ${med7.toFixed(2)}%`);

      // RSI
      const rsiMain = (typeof lastRsiVal==='number' && isFinite(lastRsiVal)) ? lastRsiVal.toFixed(1) : null;
      set('kpiStripRsiMain', rsiMain);
      // rsi label is already rendered in the full view; keep strip short
      set('kpiStripRsiSub', rsiMain==null ? null : (lastRsiVal>=70 ? 'è²·ã‚ã‚Œã™ã' : (lastRsiVal<=30 ? 'å£²ã‚‰ã‚Œã™ã' : 'ä¸­ç«‹')));

      // Sentiment
      set('kpiStripSentMain', (sentScore==null) ? null : String(Math.round(sentScore)));
      set('kpiStripSentSub', sentLabel);

      // --- Summary (top) KPI tiles ---
      const setSum = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = (txt==null||txt==='') ? 'â€”' : String(txt); };

      // Sentiment
      setSum('sumSentMain', (sentScore==null) ? null : String(Math.round(sentScore)));
      setSum('sumSentSub', sentLabel);

      // RSI
      const rsiTag = (lastRsiVal==null || !isFinite(lastRsiVal)) ? null : (lastRsiVal>=70 ? 'è²·ã‚ã‚Œã™ã' : (lastRsiVal<=30 ? 'å£²ã‚‰ã‚Œã™ã' : 'ä¸­ç«‹'));
      setSum('sumRsiMain', (lastRsiVal==null || !isFinite(lastRsiVal)) ? null : String(Math.round(lastRsiVal)));
      setSum('sumRsiSub', rsiTag);

      // Dominance (BTC)
      const totalMc = (o && typeof o.totalMcap==='number' && isFinite(o.totalMcap) && o.totalMcap>0) ? o.totalMcap : null;
      const v0 = (o && o.values && o.values.length>0 && isFinite(o.values[0])) ? o.values[0] : null; // BTC cap
      const v1 = (o && o.values && o.values.length>1 && isFinite(o.values[1])) ? o.values[1] : null; // ETH cap
      const v2 = (o && o.values && o.values.length>2 && isFinite(o.values[2])) ? o.values[2] : null; // stable cap
      const domB = (totalMc && v0!=null) ? (v0/totalMc*100) : null;
      const domE = (totalMc && v1!=null) ? (v1/totalMc*100) : null;
      const domS = (totalMc && v2!=null) ? (v2/totalMc*100) : null;
      setSum('sumDomMain', (domB==null) ? null : (domB.toFixed(1) + '%'));
      const domSub = (domE==null && domS==null) ? null : ((domE==null?'':('ETH ' + domE.toFixed(1) + '%')) + (domE!=null && domS!=null ? ' / ' : '') + (domS==null?'':('Stbl ' + domS.toFixed(1) + '%')));
      setSum('sumDomSub', domSub);

      // Avg 24h (Top250)
      const avg24 = (o && typeof o.avgChg==='number' && isFinite(o.avgChg)) ? o.avgChg : null;
      const med24 = (o && typeof o.medianChg==='number' && isFinite(o.medianChg)) ? o.medianChg : null;
      const fmt2 = (n)=> (n==null) ? 'â€”' : ((n>=0?'+':'') + n.toFixed(2) + '%');
      setSum('sumAvg24Main', fmt2(avg24));
      setSum('sumAvg24Sub', null);

      // Breadth (24h up/down counts, Top250)
      (function(){
        const up = (o && typeof o.up==='number' && isFinite(o.up)) ? o.up : null;
        const down = (o && typeof o.down==='number' && isFinite(o.down)) ? o.down : null;
        const flat = (o && typeof o.flat==='number' && isFinite(o.flat)) ? o.flat : null;
        const total = (up!=null && down!=null) ? (up + down) : null;

        const inlineEl = document.getElementById('sumBreadthInline');
        if (inlineEl){
          if (up==null || down==null) inlineEl.textContent = 'â€”';
          else inlineEl.textContent = `â†‘${up} â†“${down}` + ((flat!=null && flat>0) ? ` ï¼${flat}` : '');
        }


        const upSeg = document.getElementById('sumBreadthSegUp');
        const downSeg = document.getElementById('sumBreadthSegDown');
        if (upSeg && downSeg){
          if (total && total > 0){
            const upPct = (up / total) * 100;
            const downPct = 100 - upPct;
            upSeg.style.width = `${upPct}%`;
            downSeg.style.width = `${downPct}%`;
            upSeg.style.opacity = '1';
            downSeg.style.opacity = '1';
          } else {
            upSeg.style.width = '50%';
            downSeg.style.width = '50%';
            upSeg.style.opacity = '0.35';
            downSeg.style.opacity = '0.35';
          }
        }
      })();


      // BTC MA cross distance (SMA50 / SMA200)
    const ma = window.__btcMaCross || null;
    if (ma && Number.isFinite(ma.distPct)) {
      const d = ma.distPct;
      const label = ma.label || (d > 0 ? 'GCå´' : d < 0 ? 'DCå´' : 'ä¸­ç«‹');
      setSum('sumMaMain', `${d>=0?'+':''}${fmtPct(d, 2)}`);
      setSum('sumMaSub', label);
      updateSummaryMaBar(d);
    } else {
      setSum('sumMaMain', 'â€”');
      setSum('sumMaSub', 'â€”');
      updateSummaryMaBar(null);
    }

    // Mini visuals
    updateSummarySentBar(sentScore);
    updateSummaryRsiBar(lastRsiVal);
    updateSummaryDomBar([domBTC, domETH, domSTB, domOTH]);

    })();

    // æŠ˜ã‚ŠãŸãŸã¿æ™‚ã¯KPI stripã ã‘æ›´æ–°ã—ã¦çµ‚äº†ï¼ˆãƒãƒ£ãƒ¼ãƒˆã®å¹…0å•é¡Œã‚’é¿ã‘ã‚‹ï¼‰
    if (isCollapsed) return;
    setTimeout(() => {
      ['breadthLine','avgLine','rsiLine','sentLine','mcapLine','mcap24hLine','volLine'].forEach(id => {
        try { if (charts[id] && typeof charts[id].resize === 'function') charts[id].resize(); } catch(_){}
      });
    }, 0);

  }

// ============ Charts / Rendering ============
  const charts = {};
  const __sparklineAttempts = new Map(); // canvasId -> attempts

  function clearCharts(){
    Object.values(charts).forEach(c => { try{ c.destroy(); }catch(e){} });
    Object.keys(charts).forEach(k => delete charts[k]);
  }

function drawSparkline(canvasId, data){
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;

  // If the canvas isn't laid out yet (size 0), retry a few times.
  const w = canvas.clientWidth || canvas.width;
  const h = canvas.clientHeight || canvas.height;
  if(!w || !h){
    const n = (__sparklineAttempts.get(canvasId) || 0) + 1;
    if(n <= 8){
      __sparklineAttempts.set(canvasId, n);
      requestAnimationFrame(() => drawSparkline(canvasId, data));
    }
    return;
  }
  __sparklineAttempts.delete(canvasId);

  const raw = Array.isArray(data) ? data : [];
  const cleaned = raw.map(v => (typeof v === "number" && Number.isFinite(v)) ? v : null);
  const finite = cleaned.filter(v => v !== null);

  const ctx = canvas.getContext("2d");
  if(finite.length < 2){
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    return;
  }

  const base = finite[0];                 // â† ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆæœ€åˆã®å€¤ï¼‰
  const enableFill = finite.length >= 10; // å°‘ãªã™ãã‚‹æ™‚ã¯å¡—ã‚‰ãªã„

  try{
    if(charts[canvasId]) charts[canvasId].destroy();

    charts[canvasId] = new Chart(ctx, {
      type: "line",
      data: {
        labels: cleaned.map((_, i) => i),
        datasets: [{
          data: cleaned,
          borderColor: "rgba(255,255,255,0.85)",
          borderWidth: 1.5,
          pointRadius: 0,
          tension: 0.25,

          // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³(base)ã‚ˆã‚Šä¸Š/ä¸‹ã§å¡—ã‚Šåˆ†ã‘
          fill: enableFill ? {
            target: { value: base },
            above: "rgba(30,136,229,0.22)", // é’
            below: "rgba(211,47,47,0.22)"   // èµ¤
          } : false,

          // fill ã® above/below ã‚’ä½¿ã†ã®ã§ã€dataset ã® backgroundColor ã¯é€æ˜ã§OK
          backgroundColor: "rgba(0,0,0,0)",
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display:false }, tooltip: { enabled:false } },
        scales: { x: { display:false }, y: { display:false } }
      }
    });
  }catch(err){
    console.warn("sparkline render failed:", canvasId, err);
    try{ if(charts[canvasId]) charts[canvasId].destroy(); }catch{}
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
}


function buildSyntheticSparkline(coin){
  // Last-resort mini sparkline from 24h change (2 points) so the canvas is never blank.
  const p1 = (coin && typeof coin.current_price === 'number' && Number.isFinite(coin.current_price)) ? coin.current_price : null;
  const ch = (coin && typeof coin.price_change_percentage_24h === 'number' && Number.isFinite(coin.price_change_percentage_24h)) ? coin.price_change_percentage_24h : null;
  if(p1 === null || ch === null) return [];
  const denom = 1 + (ch / 100);
  if(!Number.isFinite(denom) || denom === 0) return [];
  const p0 = p1 / denom;
  if(!Number.isFinite(p0)) return [];
  return [p0, p1];
}

function hasAtLeast2Finite(arr){
  if(!Array.isArray(arr)) return false;
  let n = 0;
  for(const v of arr){
    if(typeof v === "number" && Number.isFinite(v)){
      n++;
      if(n >= 2) return true;
    }
  }
  return false;
}

// --- Sparkline fallback (when sparkline_in_7d is missing) ---
const __sparklineFallbackCache = new Map(); // coinId -> Promise<number[]>

function fetchSparkline7dFallback(coinId){
  if(!coinId) return Promise.resolve([]);
  if(__sparklineFallbackCache.has(coinId)) return __sparklineFallbackCache.get(coinId);
  const url = `https://api.coingecko.com/api/v3/coins/${encodeURIComponent(coinId)}/market_chart?vs_currency=jpy&days=7`;
  const p = fetchJsonRetry(url, { retries: 1 }).then(j => {
    const arr = (j && Array.isArray(j.prices)) ? j.prices.map(x => x && x[1]).filter(v => typeof v === "number") : [];
    return arr;
  }).catch(() => []);
  __sparklineFallbackCache.set(coinId, p);
  return p;
}

// --- Sparkline 24h (1d) for gainers/volume (keeps % change label consistent) ---
const __sparkline1dCache = new Map(); // coinId -> Promise<number[]>
function fetchSparkline1d(coinId){
  if(!coinId) return Promise.resolve([]);
  if(__sparkline1dCache.has(coinId)) return __sparkline1dCache.get(coinId);
  const url = `https://api.coingecko.com/api/v3/coins/${encodeURIComponent(coinId)}/market_chart?vs_currency=jpy&days=1`;
  const p = fetchJsonRetry(url, { retries: 1 }).then(j => {
    const arr = (j && Array.isArray(j.prices)) ? j.prices.map(x => x && x[1]).filter(v => typeof v === "number") : [];
    return arr;
  }).catch(() => []);
  __sparkline1dCache.set(coinId, p);
  return p;
}


  // 7æ—¥ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã€Œç›´è¿‘24hç›¸å½“ã€ã‚’åˆ‡ã‚Šå‡ºã™ï¼ˆè¿½åŠ APIã‚’æ¸›ã‚‰ã—ã¦æ¬ æã‚’é˜²ãï¼‰
  function derive24hFrom7d(spark7d) {
    if (!Array.isArray(spark7d)) return [];
    const len = spark7d.length;
    if (len <= 2) return spark7d;
    // 7æ—¥â†’24h ã¯ 1/7ã€‚Coingecko ã® sparkline ã¯ã ã„ãŸã„æ™‚é–“é–“éš”ãŒä¸€å®šãªã®ã§å‰²åˆã§åˆ‡ã‚Šå‡ºã™
    const n = Math.max(12, Math.round(len / 7));
    return spark7d.slice(-Math.min(n, len));
  }


  function ensureChartjs(){ return (typeof Chart !== 'undefined'); }

  function computeRSISeries(prices, period = 14){
  // Wilder's RSI. Returns an array same length as prices (first values are null).
  if(!Array.isArray(prices) || prices.length < period + 1) return Array(prices?.length || 0).fill(null);

  const rsi = Array(prices.length).fill(null);

  let gainSum = 0;
  let lossSum = 0;
  for(let i=1;i<=period;i++){
    const diff = prices[i] - prices[i-1];
    if(diff >= 0) gainSum += diff; else lossSum += -diff;
  }
  let avgGain = gainSum / period;
  let avgLoss = lossSum / period;

  let rs = avgLoss === 0 ? Infinity : (avgGain / avgLoss);
  rsi[period] = 100 - (100 / (1 + rs));

  for(let i=period+1;i<prices.length;i++){
    const diff = prices[i] - prices[i-1];
    const gain = diff > 0 ? diff : 0;
    const loss = diff < 0 ? -diff : 0;

    avgGain = ((avgGain * (period - 1)) + gain) / period;
    avgLoss = ((avgLoss * (period - 1)) + loss) / period;

    rs = avgLoss === 0 ? Infinity : (avgGain / avgLoss);
    rsi[i] = 100 - (100 / (1 + rs));
  }
  return rsi;
}

function makeLineChart(canvasId, labels, series, opts){
    if (!ensureChartjs()) return;
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    // Prevent "Canvas is already in use" on refresh/re-render
    try { if (charts[canvasId]) charts[canvasId].destroy(); } catch(_){}
    try {
      if (typeof Chart !== 'undefined' && typeof Chart.getChart === 'function') {
        const existing = Chart.getChart(canvas);
        if (existing) existing.destroy();
      }
    } catch(_){}

    const datasets = series.map(s => ({
      label: s.label,
      data: s.data,
      pointRadius: 0,
      borderWidth: 2,
      borderColor: s.border,
      tension: 0.25,
      fill: false,
    }));

    charts[canvasId] = new Chart(canvas, {
      type: 'line',
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: { x: { display:false }, y: { display:false, beginAtZero: !!(opts && opts.yBeginAtZero), suggestedMin: (opts && opts.yMin != null ? opts.yMin : undefined), suggestedMax: (opts && opts.yMax != null ? opts.yMax : undefined) } }
      }
    });
  }

  // Sentiment gauge (0-100 => fear..greed). Render as a "filled" semi-gauge + needle.
  // Sentiment gauge (0-100) â€” SVG semi-gauge (mobile-safe)
  function buildSentimentGaugeSvg(score) {
    const svgNS = "http://www.w3.org/2000/svg";

    // clamp
    const s = Math.max(0, Math.min(100, Number(score) || 0));

    // --- geometry ---
    const cx = 120;
    const cy = 120;
    const r  = 90;
    const strokeW = 14;

    // åŠå††ï¼ˆå·¦=180Â°, å³=0Â°ï¼‰ã‚’ 5åˆ†å‰²ã§å¸¸æ™‚è¡¨ç¤ºï¼ˆèµ¤â†’ç·‘ï¼‰
    const segments = [
      { a0: 180, a1: 144, color: "#ff4d4f" }, // 0-20
      { a0: 144, a1: 108, color: "#ff8f1f" }, // 20-40
      { a0: 108, a1: 72,  color: "#ffd43b" }, // 40-60
      { a0: 72,  a1: 36,  color: "#6ee7b7" }, // 60-80
      { a0: 36,  a1: 0,   color: "#22c55e" }, // 80-100
    ];

    // NOTE: SVGã¯Yè»¸ãŒä¸‹æ–¹å‘ã«å¢—ãˆã‚‹ãŸã‚ã€ä¸Šå‘ãã®åŠå††ã‚’æãã«ã¯ sin ã‚’åè»¢ã™ã‚‹
    const polar = (deg) => {
      const rad = (deg * Math.PI) / 180;
      return [cx + r * Math.cos(rad), cy - r * Math.sin(rad)];
    };

    // ã€Œä¸Šå´ã®åŠå††ã€ã‚’æããŸã‚ sweep=1ï¼ˆé †æ–¹å‘å´ï¼‰ã§çµ±ä¸€ï¼ˆYåè»¢åº§æ¨™ã®ãŸã‚ï¼‰
    const arcPath = (a0, a1) => {
      const [x0, y0] = polar(a0);
      const [x1, y1] = polar(a1);
      const largeArc = 0;
      const sweep = 1;
      return `M ${x0.toFixed(2)} ${y0.toFixed(2)} A ${r} ${r} 0 ${largeArc} ${sweep} ${x1.toFixed(2)} ${y1.toFixed(2)}`;
    };

    // svg root
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("class", "sent-gauge-svg");
    svg.setAttribute("viewBox", "0 0 240 140");
    svg.setAttribute("preserveAspectRatio", "xMidYMid meet");

    // faint trackï¼ˆè–„ã„ãƒ™ãƒ¼ã‚¹ï¼‰
    const track = document.createElementNS(svgNS, "path");
    track.setAttribute("d", arcPath(180, 0));
    track.setAttribute("fill", "none");
    track.setAttribute("stroke", "rgba(255,255,255,0.10)");
    track.setAttribute("stroke-width", String(strokeW));
    track.setAttribute("stroke-linecap", "round");
    svg.appendChild(track);

    // colored segmentsï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰
    for (const seg of segments) {
      const p = document.createElementNS(svgNS, "path");
      p.setAttribute("d", arcPath(seg.a0, seg.a1));
      p.setAttribute("fill", "none");
      p.setAttribute("stroke", seg.color);
      p.setAttribute("stroke-width", String(strokeW));
      p.setAttribute("stroke-linecap", "round");
      svg.appendChild(p);
    }

    // needleï¼ˆ0=å·¦, 100=å³ï¼‰
    const ang = 180 - (s / 100) * 180; // deg
    const rad = (ang * Math.PI) / 180;
    const nr = r - 18;
    const nx = cx + nr * Math.cos(rad);
    const ny = cy - nr * Math.sin(rad);

    const needle = document.createElementNS(svgNS, "line");
    needle.setAttribute("x1", String(cx));
    needle.setAttribute("y1", String(cy));
    needle.setAttribute("x2", String(nx.toFixed(2)));
    needle.setAttribute("y2", String(ny.toFixed(2)));
    needle.setAttribute("stroke", "rgba(229,231,235,0.95)");
    needle.setAttribute("stroke-width", "2.5");
    needle.setAttribute("stroke-linecap", "round");
    svg.appendChild(needle);

    const hub = document.createElementNS(svgNS, "circle");
    hub.setAttribute("cx", String(cx));
    hub.setAttribute("cy", String(cy));
    hub.setAttribute("r", "4");
    hub.setAttribute("fill", "rgba(229,231,235,0.95)");
    svg.appendChild(hub);

    return svg;
  }

  function updateSentimentGauge(score, labelText) {
    const oldSvg = document.querySelector(".sent-gauge svg.sent-gauge-svg");
    if (oldSvg) {
      const newSvg = buildSentimentGaugeSvg(score);
      oldSvg.parentNode.replaceChild(newSvg, oldSvg);
    }

    // CSS needle is deprecated (SVG needle is used).
    const cssNeedle = document.getElementById('sentNeedle');
    if (cssNeedle) cssNeedle.style.display = 'none';

    // Update label text on the card
    const lb = document.getElementById('sentLabel');
    if (lb && labelText != null) lb.textContent = String(labelText);
  }

  function makeBaselineChart(canvasId, labels, dataArr){
    if (!ensureChartjs()) return;
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚‹ã¨ Chart.js ãŒ "Canvas is already in use" ã‚’æŠ•ã’ã‚‹ãŸã‚ã€å¿…ãšç ´æ£„ã—ã¦ã‹ã‚‰å†ç”Ÿæˆã™ã‚‹
    try {
      if (charts && charts[canvasId]) {
        charts[canvasId].destroy();
        delete charts[canvasId];
      }
    } catch(_e){}

    try {
      if (typeof Chart !== 'undefined' && typeof Chart.getChart === 'function') {
        const existing = Chart.getChart(canvas);
        if (existing) existing.destroy();
      }
    } catch(_e){}

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    charts[canvasId] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          data: dataArr,
          pointRadius: 0,
          borderWidth: 2,
          borderColor: '#e5e7eb',
          tension: 0.25,
          fill: {
            target: { value: 0 },
            above: 'rgba(30, 136, 229, 0.22)',
            below: 'rgba(211, 47, 47, 0.22)'
          }
        }]
      },
      options: {
        responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{ legend:{display:false}, tooltip:{enabled:false} },
        scales:{ x:{display:false}, y:{display:false} }
      }
    });
  }

  function makeNormalizedLine(canvasId, labels, dataArr){
    if (!ensureChartjs()) return;
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    // ãƒ‡ãƒ¼ã‚¿ã« NaN / Infinity ãŒæ··ã–ã‚‹ã¨æç”»ãŒå´©ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€ã“ã“ã§ã‚µãƒ‹ã‚¿ã‚¤ã‚º
    const clean = (dataArr || []).map(v => (Number.isFinite(v) ? v : 0));
    const last = clean.length ? clean[clean.length - 1] : 0;
    const norm = (Number.isFinite(last) && last !== 0)
      ? clean.map(v => (v / last) * 100)
      : clean.map(_ => 0);

    // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„ã—ã¦ã‹ã‚‰ä½œã‚Šç›´ã™
    if (charts[canvasId]) { try { charts[canvasId].destroy(); } catch(_){} }

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    charts[canvasId] = new Chart(ctx, {
      type:'line',
      data:{ labels: labels, datasets:[{
        data: norm,
        pointRadius:0,
        borderWidth:2,
        borderColor:'#e5e7eb',
        tension:0.25,
        fill:false,
        spanGaps:true
      }]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{ legend:{display:false}, tooltip:{enabled:false} },
        scales:{ x:{display:false}, y:{display:false} }
      }
    });
  }

  function renderInto(gridId, coins, mode, sectionKey){
    const grid = document.getElementById(gridId);
    grid.innerHTML = '';

    if (!coins || !coins.length){
      if (sectionKey === 'trend' && SECTION_ERRORS.trend){
        grid.innerHTML = '<div class="msg">ãƒˆãƒ¬ãƒ³ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä»–ã®ãƒ‡ãƒ¼ã‚¿ã¯è¡¨ç¤ºã—ã¦ã„ã¾ã™ï¼‰ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>';
        return;
      }
      grid.innerHTML = '<div class="msg">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒé…ã‚Œã¦ã„ã¾ã™ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>';
      return;
    }

    coins.forEach((coin, idx) => {
      const change = coin.price_change_percentage_24h;
      const trendClass = (typeof change === 'number') ? (change >= 0 ? 'up' : 'down') : '';
      const changeClass = (typeof change === 'number') ? (change >= 0 ? 'positive' : 'negative') : '';

      const card = document.createElement('div');
      card.className = `card ${trendClass}`;

      
      card.dataset.coinId = (coin && coin.id) ? coin.id : '';
      card.dataset.sectionKey = sectionKey;
const placementMap = {
        trend: 'index_card_trend',
        gainers: 'index_card_gainers',
        volume: 'index_card_volume',
        mcap: 'index_card_mcap'
      };
      const placement = placementMap[sectionKey] || `index_card_${sectionKey}`;

      card.onclick = () => {
        const url = coinGeckoUrlFor(coin);
        fireCtaClick({
          cta_id: 'card_open',
          placement,
          partner: 'coingecko',
          pr: 0,
          link_url: url
        });
        window.open(url, '_blank', 'noopener');
      };

      const rankCls = idx===0 ? 'rank-1' : idx===1 ? 'rank-2' : idx===2 ? 'rank-3' : '';

      const pctText = (typeof change === 'number')
        ? ((change>=0?'+':'') + change.toFixed(2) + '%')
        : '-';

      const rankText = coin.market_cap_rank ? ('#' + coin.market_cap_rank) : '-';
      const volMeta = (typeof coin.total_volume === 'number')
        ? `å‡ºæ¥é«˜(24h): ${yen(coin.total_volume)}`
        : 'å‡ºæ¥é«˜(24h): -';

      const extraMeta = (mode==='mcap')
        ? `æ™‚ä¾¡ç·é¡: ${yen(coin.market_cap)} / é †ä½: ${rankText}`
        : `æ™‚ä¾¡ç·é¡é †ä½: ${rankText}`;

      const canvasId = `sp_${sectionKey}_${(coin.id || coin.symbol || idx)}`;

      card.innerHTML = `
        <div class="rank-badge ${rankCls}">#${idx+1}</div>
        <div class="card-header">
          <div class="coin-header">
            <img class="coin-icon" src="${coin.image}" alt="${coin.name}">
            <div>
              <div class="coin-name">${coin.name}</div>
              <div class="coin-symbol">${(coin.symbol||'').toUpperCase()}</div>
            </div>
          </div>
          <div>
            <div class="price">${yen(coin.current_price)}</div>
            <div class="change ${changeClass}">24h: ${pctText}</div>
            <div class="meta">${volMeta}</div>
            <div class="meta">${extraMeta}</div>
          </div>
        </div>
        <canvas id="${canvasId}" class="sparkline" aria-label="price chart" role="img"></canvas>
      `;

      grid.appendChild(card);

      // Sparkline:
      // mcapã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§ã¯sparklineã‚’ä¿å­˜ã—ãªã„ãŸã‚ã€ç„¡ã„å ´åˆã¯ãƒ•ã‚§ãƒƒãƒã›ãšã‚¹ã‚­ãƒƒãƒ—ï¼ˆAPIç¯€ç´„ï¼‰
      if (mode==='mcap' && !(coin && coin.sparkline_in_7d && Array.isArray(coin.sparkline_in_7d.price) && coin.sparkline_in_7d.price.length)){
        return;
      }
      // be defensive. If anything goes wrong, fall back to a tiny synthetic line.
      const ensureSparklineLater = () => {
        // If no chart instance after layout/async, draw a 2-point synthetic line as last resort.
        setTimeout(() => {
          try{
            if (!charts[canvasId]){
              const syn = buildSyntheticSparkline(coin);
              if (hasAtLeast2Finite(syn)) drawSparkline(canvasId, syn);
            }
          }catch(_e){}
        }, 600);
      };

      try{

      const use24h = (sectionKey === 'gainers' || sectionKey === 'volume');
      if (use24h){
        // ã¾ãšã¯ markets(sparkline_in_7d) ã‹ã‚‰ 24h ç›¸å½“ã‚’åˆ‡ã‚Šå‡ºã—ã¦æç”»ï¼ˆè¿½åŠ APIã‚’æ¸›ã‚‰ã™ï¼‰
        const sp7 = coin?.sparkline_in_7d?.price;
        const sp24 = derive24hFrom7d(sp7);
        if (hasAtLeast2Finite(sp24)) {
          drawSparkline(canvasId, sp24);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆsparkline ãŒæ¬ ã‘ã‚‹å ´åˆï¼‰
          // ã¾ãšã¯å¿…ãšã€Œã‚µãƒ³ãƒ—ãƒ«ã€ã‚’æã„ã¦ãŠãã€å–å¾—ã§ããŸã‚‰ä¸Šæ›¸ã
          const syn0 = buildSyntheticSparkline(coin);
          if (hasAtLeast2Finite(syn0)) drawSparkline(canvasId, syn0);

          fetchSparkline1d(coin.id).then(arr => {
            if (hasAtLeast2Finite(arr)) {
              drawSparkline(canvasId, arr);
            }
          }).catch(() => {
            // å¤±æ•—æ™‚ã¯ã‚µãƒ³ãƒ—ãƒ«ã®ã¾ã¾
          });
        }
      } else {
        const sp = coin?.sparkline_in_7d?.price;
        drawSparkline(canvasId, sp);
        // Fallback: some coins don't return sparkline_in_7d (new listings etc.)
        if (!hasAtLeast2Finite(sp)) {
          // ã¾ãšã¯å¿…ãšã€Œã‚µãƒ³ãƒ—ãƒ«ã€ã‚’æã„ã¦ãŠãã€å–å¾—ã§ããŸã‚‰ä¸Šæ›¸ã
          const syn0 = buildSyntheticSparkline(coin);
          if (hasAtLeast2Finite(syn0)) drawSparkline(canvasId, syn0);

          fetchSparkline7dFallback(coin.id).then(arr => {
            if (hasAtLeast2Finite(arr)) {
              drawSparkline(canvasId, arr);
            }
          }).catch(() => {
            // å¤±æ•—æ™‚ã¯ã‚µãƒ³ãƒ—ãƒ«ã®ã¾ã¾
          });
        }
      }
      } catch(e){
        console.warn('sparkline failed:', coin?.id || coin?.symbol || idx, e);
        const syn = buildSyntheticSparkline(coin);
        if (hasAtLeast2Finite(syn)) drawSparkline(canvasId, syn);
      }
      ensureSparklineLater();
    });
  }

  function renderQuickSummary(){
    const rankIcon = (i)=> (i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':(i===2?'ğŸ¥‰':String(i+1))));
    const pctText = (n)=>{
      if (typeof n !== 'number' || !isFinite(n)) return 'â€”';
      return (n>=0?'+':'') + n.toFixed(2) + '%';
    };
    const safeTxt = (s)=> (s==null || s==='') ? 'â€”' : String(s);

    const esc = (s)=>{
      try{ return (window.CSS && CSS.escape) ? CSS.escape(s) : String(s).replace(/["\\]/g,''); }
      catch(_){ return String(s); }
    };

    function openCoinGecko(coin){
      const url = coinGeckoUrlFor(coin);
      try{
        fireCtaClick({
          cta_id: 'summary_open',
          placement: 'index_summary',
          partner: 'coingecko',
          pr: 0,
          link_url: url
        });
      }catch(_){}
      window.open(url, '_blank', 'noopener');
    }

    function scrollToCoin(gridId, coin){
      const grid = document.getElementById(gridId);
      if (!grid) return;
      const cid = (coin && coin.id) ? coin.id : '';
      let card = cid ? grid.querySelector(`[data-coin-id="${esc(cid)}"]`) : null;
      if (!card) card = grid.querySelector('.card');
      if (!card) return;
      card.scrollIntoView({ behavior:'smooth', block:'center' });
      card.classList.add('flash');
      setTimeout(()=>{ try{ card.classList.remove('flash'); }catch(_e){} }, 1300);
    }

    function fillList(listId, coins, gridId){
      const ol = document.getElementById(listId);
      if (!ol) return;
      ol.innerHTML = '';

      if (!coins || !coins.length){
        const li = document.createElement('li');
        li.className = 'summary-li muted';
        li.textContent = 'â€”';
        ol.appendChild(li);
        return;
      }

      coins.slice(0,5).forEach((coin, idx)=>{
        const li = document.createElement('li');
        li.className = 'summary-li clickable';

        const left = document.createElement('span');
        left.className = 'summary-left';

        const r = document.createElement('span');
        r.className = 'summary-rank';
        r.textContent = rankIcon(idx);

        const sym = document.createElement('span');
        sym.className = 'summary-symbol';
        sym.textContent = safeTxt((coin.symbol || '').toUpperCase() || coin.name || coin.id);

        left.appendChild(r);
        left.appendChild(sym);

        const wrap = document.createElement('span');
        wrap.className = 'summary-right-wrap';

        const pct = document.createElement('span');
        const chg = coin.price_change_percentage_24h;
        pct.className = 'summary-right ' + ((typeof chg === 'number') ? (chg>=0?'positive':'negative') : '');
        pct.textContent = pctText(chg);

        const ext = document.createElement('span');
        ext.className = 'summary-ext';
        ext.title = 'CoinGeckoã§é–‹ã';
        ext.textContent = 'â†—';
        ext.onclick = (ev)=>{
          ev.stopPropagation();
          openCoinGecko(coin);
        };

        wrap.appendChild(pct);
        wrap.appendChild(ext);

        li.appendChild(left);
        li.appendChild(wrap);

        // main click: scroll to the detailed section/card (keep user on site)
        li.onclick = ()=>{
          scrollToCoin(gridId, coin);
        };

        ol.appendChild(li);
      });
    }

    fillList('summaryTrendList', trendingCoins, 'grid-trend');
    fillList('summaryUpList', getGainersTop5(), 'grid-gainers');
    fillList('summaryVolAltList', getAltVolumeTop5(), 'grid-alt-volume');
  }

function renderAll(){
    clearCharts();
    renderInto('grid-trend', trendingCoins, 'trend', 'trend');
    renderInto('grid-gainers', getGainersTop5(), 'gainers', 'gainers');
    renderInto('grid-volume', getVolumeTop5(), 'volume', 'volume');
    renderInto('grid-alt-volume', getAltVolumeTop5(), 'alt_volume', 'alt_volume');
    renderInto('grid-mcap', getMarketCapTop20(), 'mcap', 'mcap');
    renderOverview();
    try{ renderQuickSummary(); }catch(e){ console.warn("quick summary failed", e); }

  }

  function setLoadingAll(){
    document.getElementById('grid-trend').innerHTML = '<div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div>';
    document.getElementById('grid-gainers').innerHTML = '<div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div>';
    document.getElementById('grid-volume').innerHTML = '<div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div>';
    const altVolEl = document.getElementById('grid-alt-volume');
    if (altVolEl) altVolEl.innerHTML = '<div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div>';
    document.getElementById('grid-mcap').innerHTML = '<div class="msg">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div>';
    const om = document.getElementById('overviewMsg');
    if (om){ om.style.display='none'; om.textContent=''; }
  }
  // ===== Refresh UI (auto/manual refresh without flicker) =====
  let HAS_RENDERED_ONCE = false;

  const SECTION_ERRORS = { trend:false };
  function resetSectionErrors(){ SECTION_ERRORS.trend=false; }

  function setRefreshingAll(on){
    const ids = ['grid-trend','grid-gainers','grid-volume','grid-alt-volume','grid-mcap'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('refreshing', !!on);
    });
  }



  // ============ Boot ============
  async function init(fromManualRefresh=false){
    const firstLoad = !HAS_RENDERED_ONCE;
    if (firstLoad) {
      setLoadingAll();
      resetSectionErrors();
    } else {
      setRefreshingAll(true);
      if (!IN_AUTO_REFRESH) setStatus('æ›´æ–°ä¸­â€¦');
    }

    try{
      setStatus('marketså–å¾—ä¸­â€¦');
      await loadMarketsTop250(fromManualRefresh);

      // è¿½åŠ KPI: BTC MAã‚¯ãƒ­ã‚¹è·é›¢
      try{ await loadBtcMaCross(); }catch(e){ window.__btcMaCross = null; }

      if (!marketsTop.length){
        setStatus('marketsãŒç©ºã§ã™');
        document.getElementById('grid-mcap').innerHTML = '<div class="msg">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒé…ã‚Œã¦ã„ã¾ã™ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>';
        document.getElementById('grid-trend').innerHTML = '<div class="msg">---</div>';
        document.getElementById('grid-gainers').innerHTML = '<div class="msg">---</div>';
        document.getElementById('grid-volume').innerHTML = '<div class="msg">---</div>';
        return;
      }

      setStatus('ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—ä¸­â€¦');
      try {
        await loadTrendingTop5(fromManualRefresh);
      } catch (e) {
        console.warn('[trend] fetch failed', e);
        SECTION_ERRORS.trend = true;
        trendingCoins = [];
      }

      setUpdated();
      if (!IN_AUTO_REFRESH) setStatus(fromManualRefresh ? 'æ›´æ–°ã—ã¾ã—ãŸ' : (SECTION_ERRORS.trend ? 'è¡¨ç¤ºæº–å‚™å®Œäº†ï¼ˆä¸€éƒ¨å–å¾—å¤±æ•—ï¼‰' : 'è¡¨ç¤ºæº–å‚™å®Œäº†'));
      renderAll();
      HAS_RENDERED_ONCE = true;

      markRefreshed();

    } catch(e){
      console.error('init failed:', e);
      setStatus('å–å¾—ãŒä¸€æ™‚çš„ã«ä¸å®‰å®šã§ã™');

      // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã ã‘ã€Œ---ã€ã«ç½®ãæ›ãˆã‚‹ï¼ˆæ›´æ–°æ™‚ã¯ç›´å‰ã®è¡¨ç¤ºã‚’ç¶­æŒã—ã¦ãƒãƒ©ã¤ãã‚’é˜²ãï¼‰
      if (firstLoad){
        document.getElementById('grid-trend').innerHTML = '<div class="msg">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒä¸€æ™‚çš„ã«ä¸å®‰å®šã§ã™ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>';
        document.getElementById('grid-gainers').innerHTML = '<div class="msg">---</div>';
        document.getElementById('grid-volume').innerHTML = '<div class="msg">---</div>';
        document.getElementById('grid-mcap').innerHTML = '<div class="msg">---</div>';
      }
    } finally {
      if (!firstLoad) setRefreshingAll(false);
    }
  }

  // åˆå›ãƒ­ãƒ¼ãƒ‰

  // --- Market Overview: detail toggle (charts on/off) ---
  function setupOverviewToggle(){
    const btn = document.getElementById('btnOverviewToggle');
    const wrap = document.getElementById('overviewWrap');
    if (!btn || !wrap) return;

    const KEY = 'cr_overview_detail_open_v1';

    const apply = (open, rerender=false) => {
      if (open){
        wrap.classList.remove('is-collapsed');
        btn.textContent = 'é–‰ã˜ã‚‹';
        btn.setAttribute('aria-expanded','true');
      } else {
        wrap.classList.add('is-collapsed');
        btn.textContent = 'è©³ç´°';
        btn.setAttribute('aria-expanded','false');
      }
      try{ syncHeaderHeight(); }catch(_e){}
      if (open && rerender){
        setTimeout(() => { try{ renderOverview(); }catch(_e){} }, 30);
      }
    };

    const stored = localStorage.getItem(KEY);
    let open = (stored === null) ? (window.innerWidth >= 980) : (stored === '1');
    apply(open, true);

    btn.addEventListener('click', () => {
      open = !open;
      localStorage.setItem(KEY, open ? '1' : '0');
      apply(open, true);
    });

    window.__setOverviewOpen = (v) => {
      open = !!v;
      localStorage.setItem(KEY, open ? '1' : '0');
      apply(open, true);
    };
  }
  // åˆå›ãƒ­ãƒ¼ãƒ‰
  (function boot(){
    try{ syncHeaderHeight(); setupOverviewToggle(); }catch(_e){}
    tickRefreshButton();
    init(false);
    try{ startUpdatedTicker(); }catch(_e){}
    try{ startAutoRefresh(); }catch(_e){}
  })();
;
</script>
</body>
</html>
